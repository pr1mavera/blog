<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>js模块化 | pr1mavera&#39;s blog</title>
    <meta name="description" content="一切不成体系的知识碎片都只能当做无聊的消遣">
    <link rel="icon" href="/blog/favicon.ico">
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/blog/assets/css/0.styles.c868d9db.css" as="style"><link rel="preload" href="/blog/assets/js/app.49d49959.js" as="script"><link rel="preload" href="/blog/assets/js/3.66f9ff46.js" as="script"><link rel="preload" href="/blog/assets/js/1.0064e023.js" as="script"><link rel="preload" href="/blog/assets/js/19.bc34f423.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.b17e6a5b.js"><link rel="prefetch" href="/blog/assets/js/11.96a9f392.js"><link rel="prefetch" href="/blog/assets/js/12.0c07436c.js"><link rel="prefetch" href="/blog/assets/js/13.f37a0d7c.js"><link rel="prefetch" href="/blog/assets/js/14.0f2ed949.js"><link rel="prefetch" href="/blog/assets/js/15.b12c037c.js"><link rel="prefetch" href="/blog/assets/js/16.f66ea695.js"><link rel="prefetch" href="/blog/assets/js/17.4d7c521c.js"><link rel="prefetch" href="/blog/assets/js/18.d105b441.js"><link rel="prefetch" href="/blog/assets/js/20.fbfb45a4.js"><link rel="prefetch" href="/blog/assets/js/21.c225ceb5.js"><link rel="prefetch" href="/blog/assets/js/22.9e3a65c5.js"><link rel="prefetch" href="/blog/assets/js/23.9b2216aa.js"><link rel="prefetch" href="/blog/assets/js/24.4402665b.js"><link rel="prefetch" href="/blog/assets/js/25.e48768fc.js"><link rel="prefetch" href="/blog/assets/js/26.6e0c6af0.js"><link rel="prefetch" href="/blog/assets/js/27.f7355d0e.js"><link rel="prefetch" href="/blog/assets/js/28.1307c2eb.js"><link rel="prefetch" href="/blog/assets/js/29.97e9b0fc.js"><link rel="prefetch" href="/blog/assets/js/30.11d799d8.js"><link rel="prefetch" href="/blog/assets/js/31.6226632e.js"><link rel="prefetch" href="/blog/assets/js/32.51037068.js"><link rel="prefetch" href="/blog/assets/js/33.8ea562c0.js"><link rel="prefetch" href="/blog/assets/js/34.d9b383be.js"><link rel="prefetch" href="/blog/assets/js/35.6f4fcdb2.js"><link rel="prefetch" href="/blog/assets/js/36.2de9d1e5.js"><link rel="prefetch" href="/blog/assets/js/37.1aa09447.js"><link rel="prefetch" href="/blog/assets/js/38.2571463d.js"><link rel="prefetch" href="/blog/assets/js/39.2f9cc2fd.js"><link rel="prefetch" href="/blog/assets/js/4.69c4a582.js"><link rel="prefetch" href="/blog/assets/js/40.7903fce3.js"><link rel="prefetch" href="/blog/assets/js/41.898fdea0.js"><link rel="prefetch" href="/blog/assets/js/42.59061c98.js"><link rel="prefetch" href="/blog/assets/js/43.db1479b9.js"><link rel="prefetch" href="/blog/assets/js/44.0670a23d.js"><link rel="prefetch" href="/blog/assets/js/45.e50482d5.js"><link rel="prefetch" href="/blog/assets/js/46.0d2d191b.js"><link rel="prefetch" href="/blog/assets/js/47.e70cbf71.js"><link rel="prefetch" href="/blog/assets/js/48.43575794.js"><link rel="prefetch" href="/blog/assets/js/49.d7b305be.js"><link rel="prefetch" href="/blog/assets/js/5.0fe73cb2.js"><link rel="prefetch" href="/blog/assets/js/50.d316483b.js"><link rel="prefetch" href="/blog/assets/js/51.9b9c860a.js"><link rel="prefetch" href="/blog/assets/js/52.34197678.js"><link rel="prefetch" href="/blog/assets/js/53.a112b976.js"><link rel="prefetch" href="/blog/assets/js/54.c0237cb5.js"><link rel="prefetch" href="/blog/assets/js/55.b18fd02a.js"><link rel="prefetch" href="/blog/assets/js/56.6e8b568a.js"><link rel="prefetch" href="/blog/assets/js/57.bc78fd12.js"><link rel="prefetch" href="/blog/assets/js/58.fb2f70c7.js"><link rel="prefetch" href="/blog/assets/js/6.0b6b04a3.js"><link rel="prefetch" href="/blog/assets/js/7.583d1c85.js"><link rel="prefetch" href="/blog/assets/js/8.9b24f937.js"><link rel="prefetch" href="/blog/assets/js/9.34e66468.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.c868d9db.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div><div class="theme-container" data-v-ad130a7c><div data-v-ad130a7c><div id="loader-wrapper" class="loading-wrapper" data-v-4b73742e data-v-ad130a7c data-v-ad130a7c><div class="loader-main" data-v-4b73742e><div data-v-4b73742e></div><div data-v-4b73742e></div><div data-v-4b73742e></div><div data-v-4b73742e></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out is-home" style="display:none;" data-v-262b1d1e data-v-ad130a7c data-v-ad130a7c><h3 class="title" data-v-262b1d1e>pr1mavera's blog</h3> <p class="description" data-v-262b1d1e>一切不成体系的知识碎片都只能当做无聊的消遣</p> <label id="box" class="inputBox" data-v-262b1d1e><input type="password" value="" data-v-262b1d1e> <span data-v-262b1d1e>Konck! Knock!</span> <button data-v-262b1d1e>OK</button></label> <div class="footer" data-v-262b1d1e><span data-v-262b1d1e><i class="iconfont reco-theme" data-v-262b1d1e></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-262b1d1e>vuePress-theme-reco</a></span> <span data-v-262b1d1e><i class="iconfont reco-other" data-v-262b1d1e></i> <a data-v-262b1d1e>pr1mavera</a></span> <span data-v-262b1d1e><i class="iconfont reco-copyright" data-v-262b1d1e></i> <a data-v-262b1d1e>2020</a></span></div></div> <div class="hide" data-v-ad130a7c><header class="navbar" data-v-ad130a7c><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/img/logo.png" alt="pr1mavera's blog" class="logo"> <span class="site-name">pr1mavera's blog</span></a> <div class="links"><!----> <div class="fullscreen-wrapper screenfull" data-v-669fca12><svg t="1574746366011" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5517" width="200" height="200" class="icon" data-v-669fca12><path d="M223.51420462 330.2102269h1.49573886c0 32.21590925 0.26846576 64.43181848-0.19176196 96.64772772-0.15340924 8.8977269 2.9914769 11.16051113 11.390625 10.96875 19.06107962-0.3835231 38.16051113-0.23011387 57.22159158 0.421875 8.24573887 0.26846576 10.9303981-2.30113613 10.6235788-10.62357962-0.76704538-19.67471576-0.65198887-39.38778425-0.84375-59.0625 0-2.0710231-0.65198887-4.6789769 1.87926197-5.82954538 2.5696019-1.15056848 3.8352269 1.2272731 5.40767037 2.60795462 1.15056848 1.03551113 2.22443152 2.18607962 3.33664728 3.29829538 35.09232962 35.0539769 70.26136387 70.03125 105.16193235 105.27698886 5.59943152 5.63778425 9.47301113 7.47869348 15.83948803 0.61363614 12.54119348-13.5 25.61931848-26.5397731 39.11931848-39.11931849 6.86505652-6.3664769 7.09517038-10.47017038 0.19176114-17.22017037-35.8210231-35.16903424-71.22017038-70.79829538-106.69602228-106.35085189-1.91761387-1.91761387-5.36931848-3.72017038-4.37215924-6.71164812 1.2272731-3.87357962 5.29261387-2.33948887 8.20738613-2.30113613 19.3678981 0.07670462 38.73579538 0.15340924 58.14204539 0.72869348 6.90340925 0.19176113 9.39630652-2.0710231 9.2428981-9.08948886-0.4602269-20.32670462-0.65198887-40.65340925-0.421875-60.98011386 0.07670462-7.1335231-2.76136387-9.01278424-9.47301114-9.05113614-65.31392038-0.30681848-130.66619348-0.76704538-195.98011386-1.53409076-7.74715924-0.11505652-9.47301113 2.68465925-9.43465924 9.81818152 0.30681848 32.484375 0.15340924 65.0071019 0.15340924 97.52982962m433.61079538 466.36363613l20.55681848 0.11505735c0.53693152 0.26846576 1.11221576 0.76704538 1.6875 0.76704538 37.43181848 0.26846576 74.90198887 0.421875 112.37215842 0.84375 6.25142038 0.07670462 7.09517038-3.06818152 7.05681848-8.16903424-0.30681848-23.77840924-0.23011387-47.48011387-0.69034076-71.18181849-0.26846576-14.65056848 1.11221576-29.30113613-0.92045462-43.875l-0.11505652-18.44744265c1.80255652-22.12926113 0.15340924-44.296875 0.53693152-66.42613697 0.11505652-5.5227269-3.14488613-6.7116481-7.86221575-6.71164726-21.24715925 0-42.49431848 0-63.74147773-0.38352312-5.9446019-0.11505652-7.5553981 2.41619348-7.44034077 7.82386387 0.26846576 16.22301113 0.23011387 32.484375 0.26846577 48.70738613v21.09375c-5.13920462-1.61079538-7.28693152-4.83238613-9.77982962-7.32528423-35.51420462-35.4758519-71.10511387-70.9133519-106.3508519-106.65767039-5.59943152-5.67613613-9.08948887-5.5227269-14.3821019 0-13.42329538 13.99857962-27.07670462 27.69034075-41.03693235 41.03693235-5.56107962 5.36931848-5.71448887 8.8210231-0.03835188 14.42045462 35.55255652 35.015625 70.75994348 70.37642038 105.96732961 105.73721577 2.68465925 2.68465925 6.51988613 4.71732962 7.32528342 9.28125-3.29829538 2.109375-6.7883519 1.15056848-10.04829538 1.15056765-19.40625 0-38.73579538-0.15340924-58.14204539-0.26846577-4.52556848 0-8.8210231-0.3835231-8.70596575 6.44318235 0.30681848 21.86079538 0.30681848 43.75994348 0.3835231 65.65909077 0 4.6022731 1.91761387 6.98011387 6.67329539 6.90340923 22.12926113-0.3835231 44.296875 1.265625 66.42613613-0.53693235M513.2272731 90.20170462c113.5227269 0 226.96875 0.11505652 340.453125-0.07670462 27.4602269-0.0383519 49.97301113 9.47301113 66.42613614 31.75568152 11.08380652 14.95738613 14.19034075 32.21590925 14.19034076 50.43323886-0.11505652 109.41903425-0.0383519 218.83806848-0.0383519 328.29545462 0 117.20454538-0.11505652 234.44744348 0.0767038 351.69034076 0.0383519 27.34517038-8.8977269 50.01136387-31.14204538 66.77130734-15.1875 11.50568152-32.59943152 14.765625-51.12357962 14.765625-127.8664769-0.07670462-255.73295462-0.0383519-383.59943152-0.03835272-98.79545462 0-197.59090924-0.15340924-296.38636386 0.07670462-27.72869348 0.07670462-50.6633519-9.12784076-67.34659077-31.83238613-11.0071019-14.95738613-14.19034075-32.13920462-14.15198885-50.43323887 0.11505652-141.59659076 0.07670462-283.23153424 0.07670462-424.8664769 0-85.33380652 0.11505652-170.66761387-0.07670462-256.0397731C90.5852269 143.28125 99.98153424 120.73011387 122.34090925 104.31534075c14.95738613-11.0071019 32.21590925-14.19034075 50.43323885-14.15198885 113.5227269 0.15340924 226.96875 0.07670462 340.453125 0.07670462" p-id="5518" data-v-669fca12></path></svg></div> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask" data-v-ad130a7c></div> <aside class="sidebar" data-v-ad130a7c><!---->  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>无聊的消遣</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/whatever/snabbdom源码分析.html" class="sidebar-link">snabbdom 源码分析</a></li><li><a href="/blog/whatever/客户行为收集sdk项目记录.html" class="sidebar-link">客户行为收集sdk项目记录</a></li><li><a href="/blog/whatever/记一次算法在前端的实际应用.html" class="sidebar-link">记一次算法在前端的实际应用</a></li><li><a href="/blog/whatever/对于MV*的理解.html" class="sidebar-link">对于MV*的理解</a></li><li><a href="/blog/whatever/cube-ui-“精致”的前端UI组件框架.html" class="sidebar-link">cube-ui - “精致”的前端UI组件框架</a></li><li><a href="/blog/whatever/华夏视频服务.html" class="sidebar-link">华夏视频服务</a></li><li><a href="/blog/whatever/RxJS的响应式原理.html" class="sidebar-link">RxJS的响应式原理</a></li><li><a href="/blog/whatever/可视化埋点JS-SDK技术方案.html" class="sidebar-link">可视化埋点JS-SDK技术方案</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>计算机科学基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前端基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>手写代码</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>浏览器原理及性能优化</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>nodeJs</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ES6</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>函数式编程</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>框架与原理</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前端工程实践</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-262b1d1e data-v-ad130a7c><h3 class="title" data-v-262b1d1e>js模块化</h3> <!----> <label id="box" class="inputBox" data-v-262b1d1e><input type="password" value="" data-v-262b1d1e> <span data-v-262b1d1e>Konck! Knock!</span> <button data-v-262b1d1e>OK</button></label> <div class="footer" data-v-262b1d1e><span data-v-262b1d1e><i class="iconfont reco-theme" data-v-262b1d1e></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-262b1d1e>vuePress-theme-reco</a></span> <span data-v-262b1d1e><i class="iconfont reco-other" data-v-262b1d1e></i> <a data-v-262b1d1e>pr1mavera</a></span> <span data-v-262b1d1e><i class="iconfont reco-copyright" data-v-262b1d1e></i> <a data-v-262b1d1e>2020</a></span></div></div> <div data-v-ad130a7c><main class="page reco-hide"> <div class="page-title"><h1>js模块化</h1> <hr> <div data-v-7b49930f><i class="iconfont reco-account" data-v-7b49930f><span data-v-7b49930f>pr1mavera</span></i> <i class="iconfont reco-date" data-v-7b49930f><span data-v-7b49930f>2019/11/11</span></i> <!----> <!----></div></div> <div class="theme-reco-content content__default"><h2 id="js模块化的意义"><a href="#js模块化的意义" class="header-anchor">#</a> js模块化的意义</h2> <ul><li>提供了一种更好的方式来组织变量和函数</li> <li>解决命名冲突问题</li> <li>解决变量共享问题</li> <li>解决 <code>&lt;script&gt;</code> 顺序排列难以维护的问题</li> <li>解决变量存在于全局作用域，任何代码都可以改变的问题</li></ul> <h2 id="js模块化演进历史"><a href="#js模块化演进历史" class="header-anchor">#</a> js模块化演进历史</h2> <ul><li>1999 :: <strong>直接定义依赖</strong><br>
由于 js 在设计之初的定位，基本没有模块化的概念</li> <li>2003 :: <strong>闭包模块化模式</strong><br>
通过 IFEE 及 闭包，简单解决私有变量的需求</li> <li>2003 - 2009 :: <strong>模版依赖</strong> 、 <strong>注释依赖</strong> 、 <strong>外部依赖</strong> 、 <strong>Sandbox</strong><br>
这段时间出现了五花八门的模块化思路，但是都存在种种可维护性问题，都没有解决根本问题</li> <li>2009 :: <strong>依赖注入</strong><br>
由 angular1.0 引入前端领域，但是依赖注入和解决模块化问题还差得远</li> <li>2009 :: <strong>CommonJS</strong><br>
nodeJs 的出现，带来了真正意义上的模块化方案 CommonJS（服务端代码需要跟本地文件系统交互，跟网络层面交互，模块化成为必然）<br>
真正解决模块化问题，后从 node 端逐渐发力到前端，前端需要使用构建工具模拟。</li> <li>2009 :: <strong>AMD</strong> 、 <strong>CMD</strong><br>
将 node 层面的 CommonJS 模块化方式在前端模拟，由于 node 是同步的引用本地文件，而在前端需要依靠 http 请求获取资源，实现的是一种异步的资源获取，二者实现的理念不同</li> <li>2011 :: <strong>UMD</strong><br>
同时兼容浏览器端与服务端的模块化方案，核心思想是，如果在 commonjs 环境（存在 module.exports，不存在 define），将函数执行结果交给 module.exports 实现 Commonjs，否则用 Amd 环境的 define，实现 Amd</li> <li>2015 :: <strong>ES2015 Modules</strong><br>
目前官方实现的模块化方案，之前的方案都是建立在运行时层面的，esm 是在编译期间的方案，目前还没有被浏览器实现，需要通过构建工具编译提供支持</li></ul> <h2 id="amd-cmd"><a href="#amd-cmd" class="header-anchor">#</a> AMD &amp; CMD</h2> <h3 id="amd"><a href="#amd" class="header-anchor">#</a> AMD</h3> <p>AMD规范采用异步方式加载模块，模块的加载不影响它后面语句的运行。所有依赖这个模块的语句，都定义在一个回调函数中，等到加载完成之后，这个回调函数才会运行。</p> <ul><li>代表：<code>require.js</code></li> <li>核心思想：<strong>依赖前置</strong></li></ul> <h4 id="整体概念"><a href="#整体概念" class="header-anchor">#</a> 整体概念</h4> <p>D 模块依赖了 A、B、C 三个模块，顺序将是 <code>加载并执行 A</code> -&gt; <code>加载并执行 B</code> -&gt; <code>加载并执行 C</code> -&gt; <code>执行 D</code></p> <h4 id="简单使用"><a href="#简单使用" class="header-anchor">#</a> 简单使用</h4> <ul><li>定义模块</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
    * define(dependencs?: Array&lt;string&gt;, initial: Object | Function)
    */</span>
<span class="token comment">// 直接定义一个对象</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    color<span class="token punctuation">:</span> <span class="token string">'black'</span><span class="token punctuation">,</span>
    size<span class="token punctuation">:</span> <span class="token string">'unisize'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 通过函数返回一个对象</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Do something here ...</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        color<span class="token punctuation">:</span> <span class="token string">'black'</span><span class="token punctuation">,</span>
        size<span class="token punctuation">:</span> <span class="token string">'unisize'</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 定义有依赖项的模块</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token punctuation">[</span> <span class="token string">'./cart'</span><span class="token punctuation">,</span> <span class="token string">'./inventory'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">cart<span class="token punctuation">,</span> inventory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// return an object to define the 'my/shirt' module.</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        color<span class="token punctuation">:</span> <span class="token string">'blue'</span><span class="token punctuation">,</span>
        size<span class="token punctuation">:</span> <span class="token string">'large'</span><span class="token punctuation">,</span>
        <span class="token function-variable function">addToCart</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            inventory<span class="token punctuation">.</span><span class="token function">decrement</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            cart<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>导入模块</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 导入一个模块</span>
<span class="token function">require</span><span class="token punctuation">(</span><span class="token punctuation">[</span> <span class="token string">'foo'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">foo</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// do something</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 导入多个模块</span>
<span class="token function">require</span><span class="token punctuation">(</span><span class="token punctuation">[</span> <span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token string">'bar'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">foo<span class="token punctuation">,</span> bar</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// do something</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="require-js-源码分析"><a href="#require-js-源码分析" class="header-anchor">#</a> require.js 源码分析</h4> <p>每读取到一段逻辑之前，先将所依赖的所有模块读取加载，并且维护一份已经加载的模块的缓存池，读取完成之后再执行该逻辑。<br>
一个文件即为一个模块，模块与模块之间可以依赖，也可以毫无干系。
1. require 同时作为导入的函数（require），也作为定义的函数（define）
2. 只有模块被作为依赖时，才会被通过 script 标签载入到文件节点，同时缓存进模块缓存池
3. 模块的数据结构上有 onload API，保存了一系列依赖于该模块的代码片段，相当于各个通过 require 的代码片段之间加载阶段是不阻塞的，在依赖加载完全之后才会执行回调队列
<img src="/blog/img/module/amd%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90.png" alt="amd流程分析"></p> <h4 id="部分源码："><a href="#部分源码：" class="header-anchor">#</a> 部分源码：</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 维护的模块缓存池</span>
    <span class="token keyword">var</span> moduleCache <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * require
     * 同时作为导入的函数（require），也作为定义的函数（define）
     * 只有模块被作为依赖时，才会被缓存进模块缓存池
     */</span>
    <span class="token keyword">var</span> <span class="token function-variable function">require</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">deps<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> params <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment">// 依赖加载后导出的 API 数组，后续会作为参数在执行回调的时候传入</span>
        <span class="token keyword">var</span> depCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>   <span class="token comment">// 异步加载模块的哨兵变量</span>
        <span class="token comment">// 当前模块名称</span>
        <span class="token comment">// require 作为导入模块时为'REQUIRE_MAIN'，作为定义的模块时为模块 id</span>
        modName <span class="token operator">=</span> document<span class="token punctuation">.</span>currentScript <span class="token operator">&amp;&amp;</span> document<span class="token punctuation">.</span>currentScript<span class="token punctuation">.</span>id <span class="token operator">||</span> <span class="token string">'REQUIRE_MAIN'</span><span class="token punctuation">;</span>

        <span class="token comment">// 若存在相关依赖模块</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>deps<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 依次异步的加载模块，并将模块缓存进模块缓存池</span>
            <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> len <span class="token operator">=</span> deps<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">&lt;</span>len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">i</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    depCount<span class="token operator">++</span><span class="token punctuation">;</span>
                    
                    <span class="token comment">/**
                     * 这里是关键 ！！
                     * 模块作为依赖时才会执行 loadMod ，缓存进模块缓存池
                     * 相关依赖加载完全之后，执行回调工厂
                     */</span>

                    <span class="token function">loadMod</span><span class="token punctuation">(</span>deps<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">param</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        depCount<span class="token operator">--</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>depCount <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token function">saveModule</span><span class="token punctuation">(</span>modName<span class="token punctuation">,</span> params<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            isEmpty <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>isEmpty<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 在下一个宏任务中执行回调</span>
            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">saveModule</span><span class="token punctuation">(</span>modName<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 加载模块，相当于由 define 定义的模块，需要通过 script 标签加载，并保存进模块缓存池
     */</span>
    <span class="token keyword">var</span> <span class="token function-variable function">loadMod</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">modName<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">// 模块数据结构：</span>
        <span class="token comment">// {</span>
        <span class="token comment">//     modName: 模块名称</span>
        <span class="token comment">//     status: 加载状态</span>
        <span class="token comment">//     export: 模块需要导出的 API（若存在）</span>
        <span class="token comment">//     onload: 模块加载完成后需要执行的回调队列，相当于保存了一系列依赖于该模块的代码片段</span>
        <span class="token comment">// }</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>moduleCache<span class="token punctuation">[</span>modName<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 模块缓存池已存在</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mod<span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'loaded'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 模块已加载完全，说明此时该模块以及相关依赖均加载完成，在下一个宏任务中执行回调</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// 加载中状态，将回调添加进模块的 onload 回调队列</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 模块未加载</span>
            <span class="token comment">// 加载方式为添加 script 标签，异步加载模块代码</span>
            <span class="token comment">// 将模块保存进模块缓存池</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 模块依赖初始化完成之后的回调工厂
     * 作为依赖的模块会执行 onload 队列，相当于多个回调
     * 只作为导入的代码片段的模块，直接执行回调
     */</span>
    <span class="token keyword">var</span> <span class="token function-variable function">saveModule</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">modName<span class="token punctuation">,</span> params<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>moduleCache<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>modName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 模块已存在于模块缓存池</span>
            <span class="token comment">// 意味着该模块为定义的模块，执行该模块的初始化工作，依次执行 onload 队列</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 未存在</span>
            <span class="token comment">// 意味着该模块为单纯的导入模块，直接执行回调</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// 导出 require 和 define 方法</span>
    window<span class="token punctuation">.</span>require <span class="token operator">=</span> require<span class="token punctuation">;</span>
    window<span class="token punctuation">.</span>define <span class="token operator">=</span> require<span class="token punctuation">;</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre></div><h3 id="cmd"><a href="#cmd" class="header-anchor">#</a> CMD</h3> <p>最贴近CommonJS的浏览器端异步模块化方案，简单的去除define的外包装，<strong>就是标准的CommonJS实现</strong></p> <p>CMD 规范中（前身为Modules/Wrappings规范），定义一个模块就是一个文件，形式为 <code>define(factory)</code> ，factory 即为定义模块的工厂函数，描述一份模块的初始化及导出部分。</p> <p>factory 为模块运行时提供 require, exports, module ，作为模块向外提供的接口。</p> <ul><li>代表：<code>Sea.js</code></li> <li>核心思想：<strong>依赖后置</strong> 、<strong>即用即加载</strong></li> <li>整体概念：在模块定义中，使用到某块依赖时才去手动导入，即 即用即加载</li></ul> <h4 id="简单使用（sea-js-为例）"><a href="#简单使用（sea-js-为例）" class="header-anchor">#</a> 简单使用（Sea.js 为例）</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 所有模块都通过 define 来定义</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">require<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 通过 require 引入依赖，获取模块 a 的接口</span>
    <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 调用模块 a 的方法</span>
    a<span class="token punctuation">.</span><span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 通过 exports 对外提供接口foo 属性</span>
    exports<span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token string">'bar'</span><span class="token punctuation">;</span>

    <span class="token comment">// 对外提供 doSomething 方法</span>
    exports<span class="token punctuation">.</span><span class="token function-variable function">doSomething</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// 错误用法！！!</span>
    exports <span class="token operator">=</span> <span class="token punctuation">{</span>
        foo<span class="token punctuation">:</span> <span class="token string">'bar'</span><span class="token punctuation">,</span>
        <span class="token function-variable function">doSomething</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// 正确写法，通过module.exports提供整个接口</span>
    module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
        foo<span class="token punctuation">:</span> <span class="token string">'bar'</span><span class="token punctuation">,</span>
        <span class="token function-variable function">doSomething</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// factory 为对象</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token string">&quot;foo&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;bar&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// factory 为函数</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">require<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 模块代码</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="sea-js"><a href="#sea-js" class="header-anchor">#</a> Sea.js</h4> <p>Sea.js 更多的借鉴了 Modules/2.0 及 Modules/Transport 规范，即为 CMD 模块命名，使得 CMD 模块可以合并成JS文件，形式为 <code>define(id?, deps?, factory)</code> ，通过定义的 id 来缓存模块。</p> <div class="custom-block warning"><p>Sea.js 注意点：</p> <ol><li>一个模块就是一个文件，当一个文件里有多个 define 时，<code>v1.3.1</code> 之前默认将第一个define里的模块作为主模块进行返回，之后的版本只有最后一个定义的 CMD 模块会被识别，前面定义的模块都被它覆盖了</li> <li>若没有显示的指明 id ，SeaJS 会用这个js文件的url作为它的 id</li></ol></div> <h4 id="factory-的三个参数"><a href="#factory-的三个参数" class="header-anchor">#</a> factory 的三个参数</h4> <ol><li><code>require</code> : Function，同步获取其他模块提供的接口
<ul><li>require的模块不能被返回时，应该返回 null</li> <li>require.async(id, callback?)，用来异步加载模块，加载失败时，callback 的形参为 null</li> <li>require.resolve(id)，用来返回解析后的绝对路径</li> <li>条件加载时如 <code>var func = someExpResult ? require(&quot;play&quot;) : require(&quot;work&quot;);</code> ，浏览器会将两个模块文件都下载下来，建议使用 require.async 条件加载</li></ul></li> <li><code>exports</code> : Object，仅仅是 module.exports 的一个引用，在模块内部对外提供接口</li> <li><code>module</code> : Object，模板引用
<ul><li>module.url 解析后的绝对路径</li> <li>module.dependencies 模块依赖</li> <li>module.exports 暴露模块接口数据，也可以通过 return 直接提供接口</li></ul></li></ol> <h4 id="sea-js-模块加载大致流程"><a href="#sea-js-模块加载大致流程" class="header-anchor">#</a> Sea.js 模块加载大致流程</h4> <p>SeaJS 通过 factory.toString() 拿到源码，再通过正则匹配 require 的方式来得到依赖信息。
<img src="/blog/img/module/cmd%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90.jpg" alt="amd流程分析"></p> <ol><li>通过 use 方法来加载入口模块，并接收一个回调函数， 当模块加载完成， 会调用回调函数，并传入对应的模块作为参数。</li> <li>从缓存或创建并加载 来获取到模块后，等待模块（包括模块依赖的模块）加载完成会调用回调函数。</li> <li>在图片虚线部分中，加载factory及分析出模块的依赖，按依赖关系递归执行 document.createElement(‘script’) 。</li></ol> <h3 id="amd-vs-cmd"><a href="#amd-vs-cmd" class="header-anchor">#</a> AMD vs CMD</h3> <p>AMD 与 CMD （RequireJS 与 Sea.js）的主要区别：</p> <ol><li>模块加载的时机不同
<ul><li>RequireJS - 旨在 <strong>依赖前置</strong> ，会先加载并执行全部依赖，再执行模块</li> <li>Sea.js - 旨在 <strong>即用即加载</strong> ，在模块加载运行的时候依赖了某其他模块，同步加载该依赖，加载完毕后再继续执行后续模块</li></ul></li> <li>依赖加载错误时需要的处理方式不同
<ul><li>RequireJS - 依赖加载阶段，意味着所提供支持的模块还未执行任何操作，无需考虑回滚操作</li> <li>Sea.js - 依赖加载出错，所提供支持的模块可能已经执行了某操作，需考虑回滚操作</li></ul></li> <li>设计理念不同
<ul><li>RequireJS - require 使用方法特别灵活<div class="language-js extra-class"><pre class="language-js"><code><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span> <span class="token comment">// -- gets exports of module a</span>
<span class="token function">require</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// -- fetch module a according to module name scheme</span>
<span class="token function">require</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'a.js'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// -- fetch a.js directly relative to current page</span>
<span class="token function">require</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// -- set loader config</span>
</code></pre></div></li> <li>Sea.js - 努力保持简单，并支持 CSS 模块的加载
<ul><li>保持简单，职责单一。</li> <li>遵守规范，但不拘泥。</li> <li>适度灵活。</li></ul></li></ul></li> <li>关注点不同
<ul><li>RequireJS - 兼顾 浏览器 、 Rhino 和 node</li> <li>Sea.js - 只关注 浏览器</li></ul></li></ol> <h2 id="commonjs-es6-module"><a href="#commonjs-es6-module" class="header-anchor">#</a> CommonJS &amp; ES6 Module</h2> <h3 id="commonjs"><a href="#commonjs" class="header-anchor">#</a> CommonJS</h3> <p>2009年，nodeJS 诞生了，服务端代码需要跟本地文件系统交互，跟网络层面交互，等等，模块化成为必然，CommonJS 算是真正意义上的比较完善的 js 模块化方案<br>
这里需要特别强调一下，CommonJS 模块化规范规定的是在 <strong>运行时</strong> 的模块加载规范，即在运行时即用即加载，并缓存</p> <h4 id="意义"><a href="#意义" class="header-anchor">#</a> 意义</h4> <ul><li>为了让Node.js的文件可以相互调用，Node.js提供了一个简单的模块系统</li> <li>模块是Node.js应用程序的基本组成部分</li> <li>文件和模块是一一对应的，一个Node.js文件就是一个模块</li> <li>这个文件可能是JavaScript代码、json或者编译过的C / C++扩展</li> <li>Node.js中存在4类模块：原生模块和3种文件模块</li></ul> <h4 id="模块加载-require-方法"><a href="#模块加载-require-方法" class="header-anchor">#</a> 模块加载 - <code>require</code> 方法</h4> <ul><li>传参方式<br>
require方法接受以下几种参数的传递：
<ol><li><code>http</code>、<code>fs</code>、<code>path</code> 等，原生模块</li> <li><code>./mod</code> 或者 <code>../mod</code>，相对路径的文件模块</li> <li><code>/pathtomodule/mod</code>，绝对路径的文件模块</li> <li>mod，非原生模块的文件模块</li></ol></li> <li>加载流程
<ul><li>从文件模块缓存中加载</li> <li>从原生模块加载</li> <li>从文件加载
<img src="/blog/img/module/modules-load.png" alt="模块加载流程"></li></ul></li> <li>模块缓存
<ul><li>每次加载一个模块都会被缓存，这意味着 CommonJS 是运行在运行时修改模块状态的</li> <li>所有缓存的模块都保存在 require.cache 中，以模块的绝对路径作为 key 缓存该模块导出的值</li> <li>这意味着：俩模块名相同，但是保存在不同的路径，对 require 命令来说就是不同的模块，会重新加载</li></ul></li></ul> <h4 id="模块定义-module-对象"><a href="#模块定义-module-对象" class="header-anchor">#</a> 模块定义 - <code>module</code> 对象</h4> <ul><li>module.id - 模块的识别符，通常是带有<strong>绝对路径</strong>的模块文件名。</li> <li>module.filename - 模块的文件名，带有绝对路径。</li> <li>module.loaded - 返回一个布尔值，表示模块是否已经完成加载。</li> <li>module.parent - 返回一个对象，表示调用该模块的模块。</li> <li>module.children - 返回一个数组，表示该模块要用到的其他模块。</li> <li>module.exports - 表示模块对外输出的值。</li> <li><code>exports</code> - 为了方便，Node为每个模块提供一个exports变量，仅仅是 module.exports 的一个引用，在模块内部对外提供接口</li></ul> <h3 id="es6-module"><a href="#es6-module" class="header-anchor">#</a> ES6 Module</h3> <p>正统的 JS 模块化规范，在之前的规范中对于js只有一种源文件—— <code>脚本</code>（主动的代码段），ES6 出现之后，新出现了一种源文件形式—— <code>模块</code>（被动的代码段）。引入模块方式如下（即指定<strong>解析目标</strong>为模块）</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&lt;</span>script type<span class="token operator">=</span><span class="token string">&quot;module&quot;</span> src<span class="token operator">=</span><span class="token string">&quot;xxxxx.js&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre></div><p>以下为 ESM 解析原理</p> <h4 id="名词"><a href="#名词" class="header-anchor">#</a> 名词</h4> <ul><li><strong>运行时环境</strong> - 浏览器 或者 Node</li> <li><strong>加载器</strong> - 由 <strong>运行时环境</strong> 提供，用于从模块定位符（url）加载资源</li> <li><strong>入口文件</strong> - 指定为入口的脚本，从这个入口文件开始运行时环境会顺着导入语句找出所依赖的其他代码文件</li> <li><strong>模块定位符</strong> - 模块导入、导出时的模块路径，浏览器中一般为 url ，node 中一般为本地文件的路径</li> <li><strong>模块定位算法</strong> - 每个平台都有自己的一套方式来解析<strong>模块定位符</strong>。这些方式称为<strong>模块定位算法</strong></li> <li><strong>模块记录</strong> - 构建阶段产物，是模块协议将得到的js文件（字符串）解析成浏览器（运行时环境）能理解的一种数据结构</li> <li><strong>模块环境记录</strong> - 管理 <strong>模块记录</strong> 的所有变量，跟踪每个导出对应于哪个内存地址</li> <li><strong>解析目标</strong> - 解析一个js文件需要指定 <strong>解析目标</strong> ， <strong>解析目标</strong> 不同解析的结果也不同，指定 <code>type=&quot;module&quot;</code> （node中指定后缀 <code>.mjs</code> 文件）可以将js文件以模块的文件类型解析，规范中规定 ES6 所有的模块都按照 <strong>严格模式</strong> 来解析</li> <li><strong>链接</strong> - 发生在实例化阶段，即将各个 <strong>模块记录</strong> 依照导出、导入语句与内存地址组合起来</li> <li><strong>代码</strong> - 即指令集合，描述计算机该如何运行</li> <li><strong>状态</strong> - 即变量在任何时候的真实值，存储在内存中</li> <li><strong>模块实例</strong> - 运行阶段的产物，指 <strong>代码</strong> 与 <strong>状态</strong> 的结合，即指令集和变量值的结合。</li></ul> <div class="custom-block warning"><p class="custom-block-title">几个注意点：</p> <ol><li>ESM 规范规定了模块的解析、实例化、如何运行，并没有规定模块的下载（加载），下载过程是当前运行时环境规定的（提供的<strong>加载器</strong>），浏览器中根据 <code>&lt;script&gt;</code> URL地址去加载模块文件，node中为文件系统的本地文件</li> <li>引擎是被动的，它提供各种接口（包括 ParseModule、Module.Instantiate 和 Module.Evaluate 等等），是运行时环境控制引擎什么时候该做什么</li></ol></div> <h4 id="解析流程"><a href="#解析流程" class="header-anchor">#</a> 解析流程</h4> <p>模块规范要做的事情就是将加载过来的js文件（字符串）转换成引擎能够使用的模块实例（指令集和变量值），esm 分三个阶段（commonJS同步进行，即用即加载）</p> <ol><li><strong>构建阶段</strong> - 查找，下载，然后把所有js文件（字符串）解析成一堆 <strong>模块记录</strong></li> <li><strong>实例化</strong> - 为所有模块根据<strong>模块环境记录</strong>分配内存空间（此刻还没有填充值），然后依照导出、导入语句把模块指向对应的内存地址。这个过程称为<strong>链接</strong></li> <li><strong>运行</strong> - 运行代码，从而把内存空间填充为真实值，生成多个 <strong>模块实例</strong> <img src="/blog/img/module/ESM%E8%A7%A3%E6%9E%90%E6%B5%81%E7%A8%8B.png" alt="ESM解析流程"></li></ol> <div class="custom-block tip"><p class="custom-block-title">为什么node环境中模块的加载到解析运行，都是同步的，而浏览器中需要分不同阶段处理呢？</p> <p>原因是两个运行时环境的 <strong>模块定位算法</strong> 不同：</p> <ul><li>node环境 - 资源加载依赖本地的文件系统，因此构建、解析到运行都可以同步进行</li> <li>浏览器环境 - 不同于node环境，资源的加载需要从网络上下载，同时UI渲染与JS引擎使用的是同一主线程，解析时间过长势必导致UI卡顿，因此浏览器环境将算法分为三个阶段，在构建阶段只是单纯的构建 <strong>模块记录</strong> ，并不完全解析模块完整代码</li></ul></div> <h4 id="构建"><a href="#构建" class="header-anchor">#</a> 构建</h4> <p>主要的目：使得运行时环境在不用完整解析模块实例，理解模块关系图 ！</p> <p>构建又分为三个步骤：（前两步都依靠运行时环境处理，生成模块记录是运行时环境控制引擎完成的）</p> <ol><li>确定要从哪里下载包含该模块的文件，也称为<strong>模块定位</strong>（Module Resolution）</li> <li>提取文件，通过从 URL 下载或者从文件系统加载</li> <li>解析文件为<strong>模块记录</strong></li></ol> <ul><li>动态导入<br>
构建阶段由于只建立一堆模块记录，此时变量是还没有值的（还未分配内存），因此不支持动态导入 (与 commonJS 不同)<div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> someModule <span class="token keyword">from</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/path/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>someModule<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token comment">// Error !</span>
</code></pre></div>可以使用 <code>import()</code> 语法实现动态导入依赖，引擎会将加载的文件当成了一个新的入口文件，<strong>动态导入的模块会开启一个全新的独立依赖关系树</strong></li> <li>加载器加载模块<br>
加载器使用<strong>模块映射</strong>管理缓存，即 K-V 模型，key 为 URL，加载完成之前 value 标记为加载中，加载完成之后 value 为生成的<strong>模块记录</strong></li> <li>解析模块<br>
引擎根据<strong>解析目标</strong>解析js文件，<code>type=&quot;module&quot;</code> 将作为模块解析</li></ul> <h4 id="实例化"><a href="#实例化" class="header-anchor">#</a> 实例化</h4> <p>主要的目：单独的 <strong>模块记录</strong> 之间是没有关联关系的，实例化过程即建立模块之间的关联关系 ！所有导出的函数声明都在这个阶段初始化</p> <ul><li>实例化顺序：引擎会采用<strong>深度优先的后序遍历方式</strong>，这意味着将从关系图到达最底端没有任何依赖的模块，然后设置它们的导出</li> <li>简单理解就是：A 中 import 依赖 B ，<strong>链接</strong> 过程即将 B 的导出，导入到 A 中，连接<strong>内存地址</strong>（此时还没有值）</li> <li>注意此处导出与 commonJS 的不同：
<ul><li>commonJS 为值拷贝，即导出的内容与模块的内容内存地址不相同，在导入依赖的地方将变量重新赋值并不会抛出异常</li> <li>ES Module 为值引用（实时绑定），即导入、导出所使用的变量是同一块内存地址</li></ul></li></ul> <p>这样做的好处是：使得引擎可以在不运行任何模块代码的情况下完成<strong>链接</strong>，对解决运行阶段的循环依赖问题有一定帮助</p> <h4 id="运行"><a href="#运行" class="header-anchor">#</a> 运行</h4> <p>主要的目：往已申请好的内存空间中填入真实值 ！使得模块完全可用</p> <ul><li>运行顺序：引擎会采用<strong>深度优先的后序遍历方式</strong>，与实例化阶段一致</li> <li>关于副作用：模块代码只会运行一次，因为在初始化的过程中可能会存在一些副作用（向服务器发送请求之类的）</li> <li>关于循环引用：由于 esm 使用的导出方式是值引用，因此对于循环引用，模块拿到的值始终是同一份，可以理解为<strong>实时的</strong>，因此循环引用这点在 esm 中支持的比较好（也正是由于循环引用问题，esm 在设计之初就考虑到了，因此这也是浏览器环境将 <strong>模块定位算法</strong> 分段的原因之一）</li></ul> <h3 id="cjs-vs-esm"><a href="#cjs-vs-esm" class="header-anchor">#</a> CJS vs ESM</h3> <p>个人理解：commonJS 设计初衷是为 nodejs 提供模块化支持，其模块加载原则是即用即加载，无需考虑网络层的时间消耗。ES Module 则设计用来支持浏览器端的模块化需求，从底层设计上对 <strong>模块定位算法</strong> 的分段，以及导入导出机制等等，都是为浏览器环境的运行机制所做出的调整</p> <ol><li>模块定位算法不同（由于所属环境差异，考虑性能使得资源加载的方式有不同）
<ul><li>cjs - 各阶段完全同步进行，可以理解为运行时模块化方案</li> <li>esm - 分三阶段，构建阶段只解析js文件生成模块记录，实例化阶段生成模块记录直接的关联关系，运行阶段</li></ul></li> <li>模块定位算法不同导致模块协议对于动态导入支持不同
<ul><li>cjs - 各阶段同步进行，运行时变量即有值</li> <li>esm - 导入语法解析在构建阶段，此时变量还未分配内存，因此不可用使用变量动态导入模块（可以依靠 <code>import()</code> 语法实现动态）</li></ul></li> <li>模块导出的机制不同
<ul><li>cjs - 导出为 <strong>值拷贝</strong> ，即不保存模块状态</li> <li>esm - 导出为 <strong>实时绑定</strong> ，导出和导入的模块都指向相同的内存地址，同时导入为只读，即 import 进来的引用类型不能重新赋值</li></ul></li> <li>模块导出的机制不同导致对于循环引用的处理方式不同
<ul><li>cjs - <strong>不支持循环引用</strong>，导出机制受解析顺序控制，若循环引用的模块未加载完，拿到的值为 <code>undefined</code></li> <li>esm - <strong>支持循环引用</strong>，导出机制为值引用，为实时值</li></ul></li></ol> <h2 id="其他的模块化方案"><a href="#其他的模块化方案" class="header-anchor">#</a> 其他的模块化方案</h2> <h3 id="umd"><a href="#umd" class="header-anchor">#</a> umd</h3> <p>该模块是可同时兼容浏览器端与服务端的模块化方案，形式为如下</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">global<span class="token punctuation">,</span> factory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">typeof</span> exports <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> module <span class="token operator">!==</span> <span class="token string">'undefined'</span> <span class="token operator">?</span> module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">factory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span>
    <span class="token keyword">typeof</span> define <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span> define<span class="token punctuation">.</span>amd <span class="token operator">?</span> <span class="token function">define</span><span class="token punctuation">(</span>factory<span class="token punctuation">)</span> <span class="token punctuation">:</span>
    <span class="token punctuation">(</span>global<span class="token punctuation">.</span>libName <span class="token operator">=</span> <span class="token function">factory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token string">'use strict'</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 翻译一哈</span>
<span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">global<span class="token punctuation">,</span> factory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 判断 exports 、 module 是否存在</span>
    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> exports <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> module <span class="token operator">!==</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span>
        <span class="token comment">// 是，即为 node 环境（commonJs）</span>
        <span class="token punctuation">(</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">factory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">:</span>
        <span class="token comment">// 否，判断 define 、define.amd 是否存在</span>
        <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> define <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> define<span class="token punctuation">.</span>amd<span class="token punctuation">)</span> <span class="token operator">?</span>
            <span class="token comment">// 是，即为 浏览器 环境</span>
            <span class="token function">define</span><span class="token punctuation">(</span>factory<span class="token punctuation">)</span> <span class="token punctuation">:</span>
            <span class="token comment">// 否，撒也不似</span>
            <span class="token punctuation">(</span>global<span class="token punctuation">.</span>libName <span class="token operator">=</span> <span class="token function">factory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token string">'use strict'</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 运算符优先级</span>
<span class="token comment">// ... ? ... : ...  &lt;  &amp;&amp;  &lt;  ===  &lt;  =  &lt;  typeof</span>
</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">12/2/2019, 9:23:57 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/blog/FE-Foundation/前端基础/html语义化.html" class="prev">
          html语义化
        </a></span> <span class="next"><a href="/blog/FE-Foundation/前端基础/类型.html">
          类型
        </a>
        →
      </span></p></div> </main> <!----> <div class="comments-wrapper" data-v-ad130a7c><!----></div></div></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-a81d141e data-v-a81d141e><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-a81d141e><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-a81d141e></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-a81d141e></path></svg></div></div></div>
    <script src="/blog/assets/js/app.49d49959.js" defer></script><script src="/blog/assets/js/3.66f9ff46.js" defer></script><script src="/blog/assets/js/1.0064e023.js" defer></script><script src="/blog/assets/js/19.bc34f423.js" defer></script>
  </body>
</html>
