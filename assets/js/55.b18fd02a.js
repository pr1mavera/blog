(window.webpackJsonp=window.webpackJsonp||[]).push([[55],{350:function(t,s,a){"use strict";a.r(s);var n=a(0),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h2",{attrs:{id:"感性认识"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#感性认识"}},[t._v("#")]),t._v(" 感性认识")]),t._v(" "),a("p",[t._v("现阶段对于用户行为收集的方式，大抵分为三种：")]),t._v(" "),a("ul",[a("li",[a("strong",[t._v("埋点上报")]),t._v("：前端开发人员在代码中添加需要收集的数据信息，上报给服务。这种方式的优点是数据收集的很全，并且数据来源比较灵活，缺点是开发人员的工作量会比较大，并且对于一些历史项目不太友好。")]),t._v(" "),a("li",[a("strong",[t._v("全埋点")]),t._v("：通过添加一段js脚本，给页面上几乎所有（实际上是大多数常用的事件，记录dom的所有事件是不现实的）的事件绑定监听，记录全量日志。这种方式的局限性比较大，数据收集的目的性不强，并且有可能收集不全。")]),t._v(" "),a("li",[a("strong",[t._v("可视化埋点")]),t._v("：通过一种可视化的配置界面，提供给开发人员或者是业务工作人员自定义配置的能力，同时在用户使用的时候添加相应的事件监听。这种方式的好处是开发人员在代码方面的工作比较轻量，只需要引入一段js脚本，并且对配置人员的代码熟悉程度要求不高，缺点是数据收集完全依赖于配置，没有配置的用户行为完全监控不了，这对于产品的优化方面并不友好（可能由于界面设计或者交互体验的问题，用户在某个业务线上来回折腾，而迟迟不能完成功能，这种行为监控起来就比较麻烦了）。")])]),t._v(" "),a("p",[t._v("上面的三种情况各有利弊，综合考虑，我们尝试采用 "),a("strong",[t._v("全埋点")]),t._v(" 加 "),a("strong",[t._v("可视化埋点")]),t._v(" 的组合方案，即在收集全量日志的同时，配合可视化埋点的配置整合起来，上报给服务。")]),t._v(" "),a("h2",{attrs:{id:"两种模式"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#两种模式"}},[t._v("#")]),t._v(" 两种模式")]),t._v(" "),a("p",[t._v("由于目标页面需要兼顾行为收集和配置添加，因此在JS-SDK内部存在两种模式："),a("strong",[t._v("埋点模式")]),t._v(" 和 "),a("strong",[t._v("配置模式")]),t._v("。")]),t._v(" "),a("h3",{attrs:{id:"埋点模式"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#埋点模式"}},[t._v("#")]),t._v(" 埋点模式")]),t._v(" "),a("p",[t._v("当JS-SDK初始化的时候，会首先去拿一次配置信息，再给整个document的submit、change、click等一系列事件设置监听器，同时比较配置信息和添加的默认埋点事件比较，将需要特殊记录的事件绑定单独的监听器。当document的监听器监听到绑定的事件时，会先根据event.target去拿到当前目标元素的id，与配置信息比较，区分普通事件和特殊事件上报给服务。")]),t._v(" "),a("h3",{attrs:{id:"配置模式"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置模式"}},[t._v("#")]),t._v(" 配置模式")]),t._v(" "),a("p",[t._v("可视化配置页开启配置的方式是用一个iframe去加载目标页，并且配置页和目标页的数据通信通过postmassage来完成（需指定origin）。"),a("br"),t._v("\n开启配置模式需要在配置页的iframe添加对应的签名作为query，并且出于安全考虑，JS-SDK只负责在配置的时候高亮显示目标元素，而目标元素对应的事件信息的添加以及保存，全部交由配置页处理。")]),t._v(" "),a("p",[t._v("这里附上GrowingIO的可视化配置截图：")]),t._v(" "),a("p",[a("img",{attrs:{src:"/blog/img/ha-js-sdk/GrowingIO.png",alt:"GrowingIO可视化配置"}})]),t._v(" "),a("h2",{attrs:{id:"元素定位策略"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#元素定位策略"}},[t._v("#")]),t._v(" 元素定位策略")]),t._v(" "),a("p",[t._v("对于用户行为的触发单元，元素定位是必不可少的，我们需要确定到页面上的某个唯一的元素并拿到它的 ID（此处的id类似于元素的签名，并非css的id选择器），之前想要用 "),a("code",[t._v("XPath")]),t._v(" 作为元素的签名，但是如果页面嵌套过深，XPath会很长，在服务记录的时候比较消耗资源，后来参考了 "),a("a",{attrs:{href:"https://github.com/rowthan/whats-element",title:"https://github.com/rowthan/whats-element",target:"_blank",rel:"noopener noreferrer"}},[t._v("whats-element"),a("OutboundLink")],1),t._v(" 的方式，并做了一些优化处理。")]),t._v(" "),a("p",[t._v("通过对 "),a("code",[t._v("whats-element")]),t._v(" 的源码分析，大致思路如下：")]),t._v(" "),a("ol",[a("li",[t._v("检查Ele是否是HTMLElement")]),t._v(" "),a("li",[t._v("检查是否存在id")]),t._v(" "),a("li",[t._v("若上一步未命中，检查是否存在name")]),t._v(" "),a("li",[t._v("若上一步未命中，检查是否有className")]),t._v(" "),a("li",[t._v("若上一步未命中，用混合查找的方式查找")]),t._v(" "),a("li",[t._v("若上一步未命中，用querySelectorAll命中所有的元素，遍历过滤")]),t._v(" "),a("li",[t._v("若上一步未命中，用递归的方式查找父级，再用querySelectorAll命中所有的元素，遍历过滤")])]),t._v(" "),a("p",[t._v("可以看到任何一个步骤只要命中了目标元素，后面的就直接跳过，并且每一个步骤都是越来越深层次的匹配。其目的就是尽量收集到更少更简单的元素信息，并且又能拿到唯一代表一个元素的句柄。")]),t._v(" "),a("p",[t._v("以下为源码部分：（为了方便阅读，只提取关键代码）")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[t._v("whatsElementPure"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("prototype"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("getUniqueId")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("element"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" parent")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 输入：event.target，作为 element")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("element "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("instanceof")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("HTMLElement")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 1. 检查Ele是否是HTMLElement")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 初始化配置")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" result "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        wid"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("''")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        type"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("''")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 2. 检查是否存在id")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("id "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" document"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getElementById")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" element"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 判断：getElementById(id) === Ele")]),t._v("\n        result"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("wid "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token template-string"}},[a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("tag"),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("#")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("id"),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),t._v("\n        result"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("type "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'document.getElementById()'")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 3. 检查是否存在name")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("result"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("wid "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" name "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" document"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getElementsByName")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" element"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 判断：getElementsByName(name)[0] === Ele")]),t._v("\n        result"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("wid "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" name\n        result"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("type "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'document.getElementsByName()'")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 4. 检查是否有className")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("result"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("wid "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" className "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" document"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("querySelector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("tag"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v("className"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" element"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 判断：querySelector(tag+className) === Ele")]),t._v("\n        result"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("wid "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" tag"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v("className\n        result"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("type "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'document.querySelector()'")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 5. 用混合查找的方式")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("result"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("wid"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 拼接tag+name+className")]),t._v("\n        queryString "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" tag"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        queryString "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" queryString "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" className\n        queryString "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token template-string"}},[a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("queryString"),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("[name='")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("name"),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("']")]),a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("whatsElementPure"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("prototype"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getTarget")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("queryString"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" element"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            result"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("wid "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" queryString\n            result"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("type "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'document.querySelector()'")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 6. 用querySelectorAll命中所有的元素，遍历过滤")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("result"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("wid"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 拼接tag+className")]),t._v("\n        queryString "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" tag\n        queryString "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token template-string"}},[a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("queryString"),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("className"),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),t._v("\n\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" elements "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" document"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("querySelectorAll")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("queryString"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v('// 遍历匹配querySelector(queryString+:nth-child("+index+")) === Ele')]),t._v("\n        queryString "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token template-string"}},[a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("queryString"),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v(":nth-child(")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("index"),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),t._v("\n        result"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("wid "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" queryString\n        result"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("type "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'document.querySelector()'")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 7. 用递归的方式查找父级，再用querySelectorAll命中所有的元素，遍历过滤")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("result"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("wid"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 递归拿到父级句柄")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" parentQueryResult "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" whatsElementPure"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("prototype"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getUniqueId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("element"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("parentNode"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        parentQueryString "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" parentQueryResult"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("wid\n\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 拼接父子句柄")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" queryString "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token template-string"}},[a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("parentQueryString"),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("tag"),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),t._v("\n\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" queryElements "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" document"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("querySelectorAll")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("queryString"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v('// 遍历匹配querySelector(parentQueryString+">"+queryString+:nth-child("+index+")) === Ele')]),t._v("\n        queryString "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token template-string"}},[a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("parentQueryString"),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("tag"),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v(":nth-child(")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("index"),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),t._v("\n        result"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("wid "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" queryString\n        result"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("type "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'document.querySelector()'")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 输出结果")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" result\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 混合方式查找")]),t._v("\nwhatsElementPure"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("prototype"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("getTarget")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("queryString")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" document"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getElementById")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("queryString"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" document"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getElementsByName")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("queryString"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" document"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("querySelector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("queryString"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("可以看到想要定位一个元素，实际上不一定需要拿到元素完整的 "),a("code",[t._v("XPath")]),t._v(" ，我们只要获取到某个签名串，能够通过浏览器的DOM操作API拿到唯一一个元素，这就是我们想要的元素 ID。")]),t._v(" "),a("h2",{attrs:{id:"全埋点事件监听"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#全埋点事件监听"}},[t._v("#")]),t._v(" 全埋点事件监听")]),t._v(" "),a("p",[t._v("想要记录全量日志，就需要对于各种dom事件添加监控，这些事件可以大致分为 "),a("strong",[t._v("瞬发事件")]),t._v(" 和 "),a("strong",[t._v("持续事件")]),t._v(" 。这里我们提供了一些基础事件的监控：")]),t._v(" "),a("h3",{attrs:{id:"瞬发"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#瞬发"}},[t._v("#")]),t._v(" 瞬发")]),t._v(" "),a("ul",[a("li",[t._v("load：加载事件")]),t._v(" "),a("li",[t._v("online / offline：连线、离线状态事件")]),t._v(" "),a("li",[t._v("focus / blur：焦点聚集、焦点失去事件，（过滤出 "),a("code",[t._v("input")]),t._v(" / "),a("code",[t._v("textarea")]),t._v(" ）")]),t._v(" "),a("li",[t._v("click / dblclick：单击、双击事件，（过滤出 "),a("code",[t._v("a")]),t._v(" / "),a("code",[t._v("input")]),t._v(" / "),a("code",[t._v("button")]),t._v(" ）")]),t._v(" "),a("li",[t._v("play / pause：播放、暂停事件，（过滤出 "),a("code",[t._v("video")]),t._v(" / "),a("code",[t._v("audio")]),t._v(" ）")]),t._v(" "),a("li",[t._v("popstate / hashchange：路由变化事件")])]),t._v(" "),a("h3",{attrs:{id:"持续"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#持续"}},[t._v("#")]),t._v(" 持续")]),t._v(" "),a("ul",[a("li",[t._v("change：输入事件，（过滤出 "),a("code",[t._v("input")]),t._v(" / "),a("code",[t._v("textarea")]),t._v(" ）")]),t._v(" "),a("li",[t._v("touchmove：滑动事件")])]),t._v(" "),a("div",{staticClass:"custom-block warning"},[a("p",{staticClass:"custom-block-title"},[t._v("注意：")]),t._v(" "),a("p",[t._v("由于记录全量日志，对于服务的压力会比较大，因此持续事件的记录需要做限流处理（如滚动事件200ms记录一次，输入事件在停止输入之后的300ms后记录一次，具体情况具体分析）。")])]),t._v(" "),a("h2",{attrs:{id:"event事件模型"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#event事件模型"}},[t._v("#")]),t._v(" Event事件模型")]),t._v(" "),a("p",[t._v("这里我们参考了神策的 "),a("code",[t._v("Event-User")]),t._v(" 事件模型。\n一个 "),a("code",[t._v("Event")]),t._v(" 就是描述了：一个用户在某个时间点、某个地方，以某种方式完成了某个具体的事情。"),a("br"),t._v("\n从这可以看出，一个完整的Event，包含如下的几个关键因素：")]),t._v(" "),a("h3",{attrs:{id:"who"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#who"}},[t._v("#")]),t._v(" who")]),t._v(" "),a("p",[t._v("即参与这个事件的用户是谁。根据我们的实际情况，我们使用 primary_id 来设置用户的唯一的cookie作为匿名 ID。同时我们也会去抓取 "),a("code",[t._v("location.query")]),t._v(" 里面的 "),a("code",[t._v("openId")]),t._v(" 字段（如果能正常获取到），上报nginx日志，作为在spark数据聚合处理阶段阶段，关联上用户五要素使用，形成完整的用户视图。")]),t._v(" "),a("h3",{attrs:{id:"when"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#when"}},[t._v("#")]),t._v(" when")]),t._v(" "),a("p",[t._v("即这个事件发生的实际时间。在我们的数据接口中，会同时记录服务端和客户端的时间，前者作为统一时间线，后者提供给某些记录时长的数据使用，二者都精确到毫秒。")]),t._v(" "),a("h3",{attrs:{id:"where"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#where"}},[t._v("#")]),t._v(" where")]),t._v(" "),a("p",[t._v("即事件发生的地点。nginx日志会记录用户访问时候的IP地址，根据IP我们可以获取到用户的具体地址、经纬度等信息。")]),t._v(" "),a("h3",{attrs:{id:"how"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#how"}},[t._v("#")]),t._v(" how")]),t._v(" "),a("p",[t._v("即用户从事这个事件的方式。这个概念就比较广了，包括用户使用的设备、使用的浏览器、操作系统版本、进入的渠道、跳转过来时的 referer 等。"),a("br"),t._v('\n1. $browser： 浏览器信息，字符串类型，如"Chrome"。'),a("br"),t._v('\n2. $model： 设备型号，字符串类型，如"iphone6"。'),a("br"),t._v('\n3. $os： 操作系统，字符串类型，如"iOS"。'),a("br"),t._v('\n4. $os_version： 操作系统版本，字符串类型，如"8.1.1"。'),a("br"),t._v("\n5. $screen_height： 屏幕高度，数字类型，如1920。"),a("br"),t._v("\n6. $screen_width： 屏幕宽度，数字类型，如1080。"),a("br"),t._v("\n7. $wifi： 是否 WIFI，BOOL类型，如true。")]),t._v(" "),a("h3",{attrs:{id:"what"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#what"}},[t._v("#")]),t._v(" what")]),t._v(" "),a("p",[t._v("描述用户所做的这个事件的具体内容。在我们的数据接口中，首先是使用 "),a("code",[t._v("event")]),t._v(" 记录当前触发的dom事件名称，来对用户所做的内容做初步的分类。后续在可视化配置阶段会提供给配置人员设置特殊事件（附带感情色彩的事件，可以是用户某个具体行为的目的，也可以是各种业务相关的功能事件）的入口。下面给出一些典型的例子:"),a("br"),t._v("\n1. 对于一个“购买”类型的事件，则可能需要记录的字段有：商品名称、商品类型、购买数量、购买金额、付款方式等。"),a("br"),t._v("\n2. 对于一个“搜索”类型的事件，则可能需要记录的字段有：搜索关键词、搜索类型等。"),a("br"),t._v("\n3. 对于一个“填写表格”类型的事件，则可能需要记录的字段有：表格类型、表格关键信息等。"),a("br"),t._v("\n4. 对于一个“用户注册”类型的事件，则可能需要记录的字段有：注册渠道、用户基本信息等。")]),t._v(" "),a("h2",{attrs:{id:"整体流程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#整体流程"}},[t._v("#")]),t._v(" 整体流程")]),t._v(" "),a("p",[t._v("根据以上各技术细节的描述，可将整体流程概括为两方面：")]),t._v(" "),a("ul",[a("li",[a("p",[t._v("行为记录：")]),t._v(" "),a("ol",[a("li",[t._v("JS-SDK被添加进目标页面，初始化。")]),t._v(" "),a("li",[t._v("读取配置信息json，配合全埋点的默认事件，给目标页面元素绑定上对应的监听。")]),t._v(" "),a("li",[t._v("用户触发某个功能埋点，JS-SDK请求一张1*1大小的gif，并附带相应的数据，在nginx保存一条日志。")])])]),t._v(" "),a("li",[a("p",[t._v("配置：")]),t._v(" "),a("ol",[a("li",[t._v("配置人员打开目标界面。")]),t._v(" "),a("li",[t._v("输入URL，打开目标页面。")]),t._v(" "),a("li",[t._v("开启配置功能，选择目标元素。")]),t._v(" "),a("li",[t._v("添加相应事件信息。")]),t._v(" "),a("li",[t._v("点击保存配置，将配置信息json保存在服务某处。")])])])]),t._v(" "),a("h2",{attrs:{id:"总结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[t._v("#")]),t._v(" 总结")]),t._v(" "),a("p",[t._v("无埋点用户行为收集实际上并非无埋点，而是通过可视化配置埋点的方式将需要记录的具体用户行为做抽象，达到收集的数据更具有目的性，并且最大限度的减轻人力成本的目的。数据收集的准确度直接影响后续数据分析的结果，我们需要在后续的开发和维护中根据具体细节作出相应调整。")])])}),[],!1,null,null,null);s.default=e.exports}}]);