---
title: 华夏视频服务
date: 2019-07-03
tags: 
 - 随便写写
---

## 遇到的问题
空中柜面项目上线生产之后，陆续出现其他业务想要接入视频服务的情况，然而在我们为不同需求定制业务逻辑的时候发现以下问题：
1. 大量**兼容性代码**和**视频各模块的生产监控机制**充斥在主要的业务逻辑中，导致想要将其中的业务逻辑单独拎出来重写十分的困难
2. 空中柜面项目集合了客服系统的三条业务线(机器人、人工客服、视频客服)，由于当时经验不足且考虑不周，三条业务线的**耦合性很高**，拆分时即使是单独保留视频服务，依旧存在很多另外两条业务线的残留逻辑不敢删

这些问题在将视频服务接入视频保全项目的时候暴露出来，光是无关的业务逻辑的删减就花了将近**一周时间**，可以想象后续接入其他业务时这些问题将依旧存在，严重影响开发进度。

## 共通的业务
在帮助其他业务接入视频的过程中，我们发现以下内容是无论哪种业务场景都真正关心的：

**排队：**
1. 开始排队
2. 取消排队
3. 排队人数减少 | listener
4. 排队成功 | listener
5. 排队失败 | listener

**视频：**
1. 连接视频 (包括第一次连接和重连)
2. 挂断视频 (完全结束)
3. 获取视频记录 (视频次数、分别时长、总时长)
4. 视频异常断开 (远程流) | listener

**其他的可注册的监听：**
1. 接收C2C消息 (包括任何来源：机器人、在线、视频 。。。) | listener
2. 视频过程中的双击事件 | listener
3. 。。。

**另外需要暴露的方法：**
1. 获取用户信息
2. 坐席信息的注册及获取，相当于作为全局的状态保存着，可后续增量
3. 发送C2C消息 (包括任何来源：机器人、在线、视频 。。。，通过type区别发送对象)
4. 。。。

这些说白了依旧属于业务逻辑，但是无论是哪个项目接入，这些都是**统一的视频的逻辑**，是作为我们视频能力的体现。我们可以将它们整体包装出来单独做成**视频的公共服务**。

在视频的整个流程中还包括其他的子逻辑，比如排队时候的**心跳机制**、排队和视频接通的**超时机制**、视频质量的**检测和上报**等等。这些都是视频流程中的很重要的机制，但是对于不同的业务线(比如视频保全)来说他们并不关心，他们的业务逻辑只关心我啥时候能排队成功，啥时候能看到视频坐席。因此如果将这些和各业务逻辑写在一起，无论是今后的拆分还是维护工作，都将存在巨大的人力成本和学习成本。

## 状态切换
另外，考虑到之后接入其他不同的业务线的拓展性，以及将空中柜面的三条业务线可能都要迁移至小程序，在抽象公共服务的时候个人觉得需要保留现有的三条业务线及其转换接口，这个全局的状态切换在空中柜面就没做好。

我现在的想法是：
+ 通过Redis拿到的不同业务的配置信息在前端维护一个当前业务的**状态机机制**，在三个客服业务(机器人、在线、视频)以及客服列表、排队等几个子状态之间形成闭环。从配置信息生成出状态机就需要约定数据结构及算法了。
+ 三个客服业务中某些统一的接口(发消息接口、排队接口)用策略模式做成三个**控制器**，状态机的切换控制不同控制器的切换，这样就不用写一堆 `if else` 的逻辑。

当然这些都是我现在自己YY的想法，可能存在对场景和设计模式的理解误区，也可能根本不需要设计的这么复杂，需要大家讨论协商。



<!-- ## 初始化
### 流程
1. 获取业务数据，
### 使用
在app.js中获取到openId及来源，执行并绑定在globalData上
```js
// app.js
const { origin, openId } = location.query.origin
const hx = require('hx-video-server')
App({
    globalData: {
        hx: hx({
            origin,
            openId
        })
    }
})
```

## 业务配置信息
```js
queue: {
    server: 'user-server',
    method: 'post',
    path: '/video/user/queue',
    args: [ 'userId', 'userName', 'csId', 'csName', 'nickName', 'toCsFlag', 'origin', 'priority', 'robotSessionId' ]
}
```
根据客户来源从Redis获取业务数据，内部生成
	- _config
	+ getConfig(origin)
个人信息
	- _userData
	- _appIdData
	+ get
openId

## 专属客服


## 排队


## 视频 -->

