---
title: jQuery核心思想
date: 2019-06-22
tags: 
 - 阿灯
---

## 初始化jQuery
从使用角度看，jQuery可以实例化也可以直接用，即 `new $('.test')` 和 `$('.test')` ，那么一定在jQuery内部默默的 `new` 了一下，先看看jQuery初始化的代码（简化）：
```js
(function (window, undefined) {
    var jQuery = function (selector, context) {
        // new 的情况
        // 默默给做了一个new jQuery()
        return new jQuery.fn.init(selector, context);
    }
    jQuery.fn = jQuery.prototype = {
        init: function (selector, context) {

        },
        val: function () {
            // ...
        }
    }
    jQuery.fn.init.prototype = jQuery.fn
    // 相当于 jQuery.fn.init.prototype === jQuery.fn === jQuery.prototype
})(window);
```
执行完初始化，我们可以得到以下公式：  
`jQuery.fn.init.prototype === jQuery.fn === jQuery.prototype`

现在来看使用的两种情况：
+  `new $('.test')` ：new关键字实际上走了jQuery的构造函数，并且 `jQuery.prototype` 上挂载的init方法被搁置，我们可以通过 `.val()` 之类的拿到原型链上的所有方法。
+  `$('.test')` ：如果只是调用了jQuery，实际上内部返回了一个 `jQuery.fn.init` 的实例，而我们又知道 `jQuery.fn.init.prototype === jQuery.fn === jQuery.prototype` ，即 `jQuery.fn.init` 的实例同样可以通过 `.val()` 之类的拿到原型链上的所有方法。

**jQuery初始化绕了这么一大圈，目的就是为了能够拿到jQuery原型链上的方法，无论有没有new关键字去实例化jQuery！！**

`jQuery.fn.init` 实际上就是承载了我们使用jQuery时有没有 `new` 关键字的问题，有则忽略并初始化，没有的话实际上就是调用了 `jQuery.prototype` 上的 `.init()` 方法，完成初始化。

## 链式调用
链式调用实际上就是每次调用完方法之后将自己return出去
```js
var s = {
    a: function () {
        console.log('a');
        return this;
    },
    b: function () {
        console.log('b');
        return this;
    },
    c: function () {
        console.log('c');
        return this;
    }
}
s.a().b().c()
```

## 函数重载
平时开发会写 `$('')` 很多情况： `$('.test')` ， `$('#id', '.test)` ...，那么想要在同一个方法内通过改变传参做不同的事情，就需要对传递的参数做处理。方法有很多，jQuery内部使用的是一种函数重载的机制，通过闭包存贮变量的能力实现的：
```js
function addMethods (obj, name, f) {
    var old = obj[name]; // 用闭包保存变量！！
    obj[name] = function () {
        if (f.length === arguments.length) {
            /*
             * f: 实参
             * arguments: 形参
             */
            f.apply(this, arguments)
        } else {
            old.apply(this, arguments)
        }
    }
}
var people = {
    name: [ '张三', '李四', '王二麻' ]
}
addMethods(people, 'find', findNameList) // 挂载获取全部名字列表的函数
addMethods(people, 'find', findName) // 挂载获取单个名字的函数

function findNameList () {
    console.log(people.name);
}
function findName (name) {
    var arr = people.name;
    for (var i = 0; i <= arr.length; i++) {
        if (arr[i] === name) {
            console.log(`${name}在第${i}位`);
        }
    }
}
function find (a, b) {
    console.log(a + b)
}
```
