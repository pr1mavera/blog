<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>可视化埋点JS-SDK技术方案 | pr1mavera&#39;s blog</title>
    <meta name="description" content="一切不成体系的知识碎片都只能当做无聊的消遣">
    <link rel="icon" href="/blog/favicon.ico">
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/blog/assets/css/0.styles.c868d9db.css" as="style"><link rel="preload" href="/blog/assets/js/app.49d49959.js" as="script"><link rel="preload" href="/blog/assets/js/3.66f9ff46.js" as="script"><link rel="preload" href="/blog/assets/js/1.0064e023.js" as="script"><link rel="preload" href="/blog/assets/js/55.b18fd02a.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.b17e6a5b.js"><link rel="prefetch" href="/blog/assets/js/11.96a9f392.js"><link rel="prefetch" href="/blog/assets/js/12.0c07436c.js"><link rel="prefetch" href="/blog/assets/js/13.f37a0d7c.js"><link rel="prefetch" href="/blog/assets/js/14.0f2ed949.js"><link rel="prefetch" href="/blog/assets/js/15.b12c037c.js"><link rel="prefetch" href="/blog/assets/js/16.f66ea695.js"><link rel="prefetch" href="/blog/assets/js/17.4d7c521c.js"><link rel="prefetch" href="/blog/assets/js/18.d105b441.js"><link rel="prefetch" href="/blog/assets/js/19.bc34f423.js"><link rel="prefetch" href="/blog/assets/js/20.fbfb45a4.js"><link rel="prefetch" href="/blog/assets/js/21.c225ceb5.js"><link rel="prefetch" href="/blog/assets/js/22.9e3a65c5.js"><link rel="prefetch" href="/blog/assets/js/23.9b2216aa.js"><link rel="prefetch" href="/blog/assets/js/24.4402665b.js"><link rel="prefetch" href="/blog/assets/js/25.e48768fc.js"><link rel="prefetch" href="/blog/assets/js/26.6e0c6af0.js"><link rel="prefetch" href="/blog/assets/js/27.f7355d0e.js"><link rel="prefetch" href="/blog/assets/js/28.1307c2eb.js"><link rel="prefetch" href="/blog/assets/js/29.97e9b0fc.js"><link rel="prefetch" href="/blog/assets/js/30.11d799d8.js"><link rel="prefetch" href="/blog/assets/js/31.6226632e.js"><link rel="prefetch" href="/blog/assets/js/32.51037068.js"><link rel="prefetch" href="/blog/assets/js/33.8ea562c0.js"><link rel="prefetch" href="/blog/assets/js/34.d9b383be.js"><link rel="prefetch" href="/blog/assets/js/35.6f4fcdb2.js"><link rel="prefetch" href="/blog/assets/js/36.2de9d1e5.js"><link rel="prefetch" href="/blog/assets/js/37.1aa09447.js"><link rel="prefetch" href="/blog/assets/js/38.2571463d.js"><link rel="prefetch" href="/blog/assets/js/39.2f9cc2fd.js"><link rel="prefetch" href="/blog/assets/js/4.69c4a582.js"><link rel="prefetch" href="/blog/assets/js/40.7903fce3.js"><link rel="prefetch" href="/blog/assets/js/41.898fdea0.js"><link rel="prefetch" href="/blog/assets/js/42.59061c98.js"><link rel="prefetch" href="/blog/assets/js/43.db1479b9.js"><link rel="prefetch" href="/blog/assets/js/44.0670a23d.js"><link rel="prefetch" href="/blog/assets/js/45.e50482d5.js"><link rel="prefetch" href="/blog/assets/js/46.0d2d191b.js"><link rel="prefetch" href="/blog/assets/js/47.e70cbf71.js"><link rel="prefetch" href="/blog/assets/js/48.43575794.js"><link rel="prefetch" href="/blog/assets/js/49.d7b305be.js"><link rel="prefetch" href="/blog/assets/js/5.0fe73cb2.js"><link rel="prefetch" href="/blog/assets/js/50.d316483b.js"><link rel="prefetch" href="/blog/assets/js/51.9b9c860a.js"><link rel="prefetch" href="/blog/assets/js/52.34197678.js"><link rel="prefetch" href="/blog/assets/js/53.a112b976.js"><link rel="prefetch" href="/blog/assets/js/54.c0237cb5.js"><link rel="prefetch" href="/blog/assets/js/56.6e8b568a.js"><link rel="prefetch" href="/blog/assets/js/57.bc78fd12.js"><link rel="prefetch" href="/blog/assets/js/58.fb2f70c7.js"><link rel="prefetch" href="/blog/assets/js/6.0b6b04a3.js"><link rel="prefetch" href="/blog/assets/js/7.583d1c85.js"><link rel="prefetch" href="/blog/assets/js/8.9b24f937.js"><link rel="prefetch" href="/blog/assets/js/9.34e66468.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.c868d9db.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div><div class="theme-container" data-v-ad130a7c><div data-v-ad130a7c><div id="loader-wrapper" class="loading-wrapper" data-v-4b73742e data-v-ad130a7c data-v-ad130a7c><div class="loader-main" data-v-4b73742e><div data-v-4b73742e></div><div data-v-4b73742e></div><div data-v-4b73742e></div><div data-v-4b73742e></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out is-home" style="display:none;" data-v-262b1d1e data-v-ad130a7c data-v-ad130a7c><h3 class="title" data-v-262b1d1e>pr1mavera's blog</h3> <p class="description" data-v-262b1d1e>一切不成体系的知识碎片都只能当做无聊的消遣</p> <label id="box" class="inputBox" data-v-262b1d1e><input type="password" value="" data-v-262b1d1e> <span data-v-262b1d1e>Konck! Knock!</span> <button data-v-262b1d1e>OK</button></label> <div class="footer" data-v-262b1d1e><span data-v-262b1d1e><i class="iconfont reco-theme" data-v-262b1d1e></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-262b1d1e>vuePress-theme-reco</a></span> <span data-v-262b1d1e><i class="iconfont reco-other" data-v-262b1d1e></i> <a data-v-262b1d1e>pr1mavera</a></span> <span data-v-262b1d1e><i class="iconfont reco-copyright" data-v-262b1d1e></i> <a data-v-262b1d1e>2020</a></span></div></div> <div class="hide" data-v-ad130a7c><header class="navbar" data-v-ad130a7c><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/img/logo.png" alt="pr1mavera's blog" class="logo"> <span class="site-name">pr1mavera's blog</span></a> <div class="links"><!----> <div class="fullscreen-wrapper screenfull" data-v-669fca12><svg t="1574746366011" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5517" width="200" height="200" class="icon" data-v-669fca12><path d="M223.51420462 330.2102269h1.49573886c0 32.21590925 0.26846576 64.43181848-0.19176196 96.64772772-0.15340924 8.8977269 2.9914769 11.16051113 11.390625 10.96875 19.06107962-0.3835231 38.16051113-0.23011387 57.22159158 0.421875 8.24573887 0.26846576 10.9303981-2.30113613 10.6235788-10.62357962-0.76704538-19.67471576-0.65198887-39.38778425-0.84375-59.0625 0-2.0710231-0.65198887-4.6789769 1.87926197-5.82954538 2.5696019-1.15056848 3.8352269 1.2272731 5.40767037 2.60795462 1.15056848 1.03551113 2.22443152 2.18607962 3.33664728 3.29829538 35.09232962 35.0539769 70.26136387 70.03125 105.16193235 105.27698886 5.59943152 5.63778425 9.47301113 7.47869348 15.83948803 0.61363614 12.54119348-13.5 25.61931848-26.5397731 39.11931848-39.11931849 6.86505652-6.3664769 7.09517038-10.47017038 0.19176114-17.22017037-35.8210231-35.16903424-71.22017038-70.79829538-106.69602228-106.35085189-1.91761387-1.91761387-5.36931848-3.72017038-4.37215924-6.71164812 1.2272731-3.87357962 5.29261387-2.33948887 8.20738613-2.30113613 19.3678981 0.07670462 38.73579538 0.15340924 58.14204539 0.72869348 6.90340925 0.19176113 9.39630652-2.0710231 9.2428981-9.08948886-0.4602269-20.32670462-0.65198887-40.65340925-0.421875-60.98011386 0.07670462-7.1335231-2.76136387-9.01278424-9.47301114-9.05113614-65.31392038-0.30681848-130.66619348-0.76704538-195.98011386-1.53409076-7.74715924-0.11505652-9.47301113 2.68465925-9.43465924 9.81818152 0.30681848 32.484375 0.15340924 65.0071019 0.15340924 97.52982962m433.61079538 466.36363613l20.55681848 0.11505735c0.53693152 0.26846576 1.11221576 0.76704538 1.6875 0.76704538 37.43181848 0.26846576 74.90198887 0.421875 112.37215842 0.84375 6.25142038 0.07670462 7.09517038-3.06818152 7.05681848-8.16903424-0.30681848-23.77840924-0.23011387-47.48011387-0.69034076-71.18181849-0.26846576-14.65056848 1.11221576-29.30113613-0.92045462-43.875l-0.11505652-18.44744265c1.80255652-22.12926113 0.15340924-44.296875 0.53693152-66.42613697 0.11505652-5.5227269-3.14488613-6.7116481-7.86221575-6.71164726-21.24715925 0-42.49431848 0-63.74147773-0.38352312-5.9446019-0.11505652-7.5553981 2.41619348-7.44034077 7.82386387 0.26846576 16.22301113 0.23011387 32.484375 0.26846577 48.70738613v21.09375c-5.13920462-1.61079538-7.28693152-4.83238613-9.77982962-7.32528423-35.51420462-35.4758519-71.10511387-70.9133519-106.3508519-106.65767039-5.59943152-5.67613613-9.08948887-5.5227269-14.3821019 0-13.42329538 13.99857962-27.07670462 27.69034075-41.03693235 41.03693235-5.56107962 5.36931848-5.71448887 8.8210231-0.03835188 14.42045462 35.55255652 35.015625 70.75994348 70.37642038 105.96732961 105.73721577 2.68465925 2.68465925 6.51988613 4.71732962 7.32528342 9.28125-3.29829538 2.109375-6.7883519 1.15056848-10.04829538 1.15056765-19.40625 0-38.73579538-0.15340924-58.14204539-0.26846577-4.52556848 0-8.8210231-0.3835231-8.70596575 6.44318235 0.30681848 21.86079538 0.30681848 43.75994348 0.3835231 65.65909077 0 4.6022731 1.91761387 6.98011387 6.67329539 6.90340923 22.12926113-0.3835231 44.296875 1.265625 66.42613613-0.53693235M513.2272731 90.20170462c113.5227269 0 226.96875 0.11505652 340.453125-0.07670462 27.4602269-0.0383519 49.97301113 9.47301113 66.42613614 31.75568152 11.08380652 14.95738613 14.19034075 32.21590925 14.19034076 50.43323886-0.11505652 109.41903425-0.0383519 218.83806848-0.0383519 328.29545462 0 117.20454538-0.11505652 234.44744348 0.0767038 351.69034076 0.0383519 27.34517038-8.8977269 50.01136387-31.14204538 66.77130734-15.1875 11.50568152-32.59943152 14.765625-51.12357962 14.765625-127.8664769-0.07670462-255.73295462-0.0383519-383.59943152-0.03835272-98.79545462 0-197.59090924-0.15340924-296.38636386 0.07670462-27.72869348 0.07670462-50.6633519-9.12784076-67.34659077-31.83238613-11.0071019-14.95738613-14.19034075-32.13920462-14.15198885-50.43323887 0.11505652-141.59659076 0.07670462-283.23153424 0.07670462-424.8664769 0-85.33380652 0.11505652-170.66761387-0.07670462-256.0397731C90.5852269 143.28125 99.98153424 120.73011387 122.34090925 104.31534075c14.95738613-11.0071019 32.21590925-14.19034075 50.43323885-14.15198885 113.5227269 0.15340924 226.96875 0.07670462 340.453125 0.07670462" p-id="5518" data-v-669fca12></path></svg></div> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask" data-v-ad130a7c></div> <aside class="sidebar" data-v-ad130a7c><!---->  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>无聊的消遣</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/whatever/snabbdom源码分析.html" class="sidebar-link">snabbdom 源码分析</a></li><li><a href="/blog/whatever/客户行为收集sdk项目记录.html" class="sidebar-link">客户行为收集sdk项目记录</a></li><li><a href="/blog/whatever/记一次算法在前端的实际应用.html" class="sidebar-link">记一次算法在前端的实际应用</a></li><li><a href="/blog/whatever/对于MV*的理解.html" class="sidebar-link">对于MV*的理解</a></li><li><a href="/blog/whatever/cube-ui-“精致”的前端UI组件框架.html" class="sidebar-link">cube-ui - “精致”的前端UI组件框架</a></li><li><a href="/blog/whatever/华夏视频服务.html" class="sidebar-link">华夏视频服务</a></li><li><a href="/blog/whatever/RxJS的响应式原理.html" class="sidebar-link">RxJS的响应式原理</a></li><li><a href="/blog/whatever/可视化埋点JS-SDK技术方案.html" class="active sidebar-link">可视化埋点JS-SDK技术方案</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/whatever/可视化埋点JS-SDK技术方案.html#感性认识" class="sidebar-link">感性认识</a></li><li class="sidebar-sub-header"><a href="/blog/whatever/可视化埋点JS-SDK技术方案.html#两种模式" class="sidebar-link">两种模式</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/whatever/可视化埋点JS-SDK技术方案.html#埋点模式" class="sidebar-link">埋点模式</a></li><li class="sidebar-sub-header"><a href="/blog/whatever/可视化埋点JS-SDK技术方案.html#配置模式" class="sidebar-link">配置模式</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/whatever/可视化埋点JS-SDK技术方案.html#元素定位策略" class="sidebar-link">元素定位策略</a></li><li class="sidebar-sub-header"><a href="/blog/whatever/可视化埋点JS-SDK技术方案.html#全埋点事件监听" class="sidebar-link">全埋点事件监听</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/whatever/可视化埋点JS-SDK技术方案.html#瞬发" class="sidebar-link">瞬发</a></li><li class="sidebar-sub-header"><a href="/blog/whatever/可视化埋点JS-SDK技术方案.html#持续" class="sidebar-link">持续</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/whatever/可视化埋点JS-SDK技术方案.html#event事件模型" class="sidebar-link">Event事件模型</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/whatever/可视化埋点JS-SDK技术方案.html#who" class="sidebar-link">who</a></li><li class="sidebar-sub-header"><a href="/blog/whatever/可视化埋点JS-SDK技术方案.html#when" class="sidebar-link">when</a></li><li class="sidebar-sub-header"><a href="/blog/whatever/可视化埋点JS-SDK技术方案.html#where" class="sidebar-link">where</a></li><li class="sidebar-sub-header"><a href="/blog/whatever/可视化埋点JS-SDK技术方案.html#how" class="sidebar-link">how</a></li><li class="sidebar-sub-header"><a href="/blog/whatever/可视化埋点JS-SDK技术方案.html#what" class="sidebar-link">what</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/whatever/可视化埋点JS-SDK技术方案.html#整体流程" class="sidebar-link">整体流程</a></li><li class="sidebar-sub-header"><a href="/blog/whatever/可视化埋点JS-SDK技术方案.html#总结" class="sidebar-link">总结</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>计算机科学基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前端基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>手写代码</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>浏览器原理及性能优化</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>nodeJs</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ES6</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>函数式编程</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>框架与原理</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前端工程实践</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-262b1d1e data-v-ad130a7c><h3 class="title" data-v-262b1d1e>可视化埋点JS-SDK技术方案</h3> <!----> <label id="box" class="inputBox" data-v-262b1d1e><input type="password" value="" data-v-262b1d1e> <span data-v-262b1d1e>Konck! Knock!</span> <button data-v-262b1d1e>OK</button></label> <div class="footer" data-v-262b1d1e><span data-v-262b1d1e><i class="iconfont reco-theme" data-v-262b1d1e></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-262b1d1e>vuePress-theme-reco</a></span> <span data-v-262b1d1e><i class="iconfont reco-other" data-v-262b1d1e></i> <a data-v-262b1d1e>pr1mavera</a></span> <span data-v-262b1d1e><i class="iconfont reco-copyright" data-v-262b1d1e></i> <a data-v-262b1d1e>2020</a></span></div></div> <div data-v-ad130a7c><main class="page reco-hide"> <div class="page-title"><h1>可视化埋点JS-SDK技术方案</h1> <hr> <div data-v-7b49930f><i class="iconfont reco-account" data-v-7b49930f><span data-v-7b49930f>pr1mavera</span></i> <i class="iconfont reco-date" data-v-7b49930f><span data-v-7b49930f>2019/4/29</span></i> <!----> <i class="iconfont reco-tag tags" data-v-7b49930f><span class="tag-item" data-v-7b49930f>
      技术方案
    </span><span class="tag-item" data-v-7b49930f>
      JS-SDK
    </span><span class="tag-item" data-v-7b49930f>
      可视化埋点
    </span></i></div></div> <div class="theme-reco-content content__default"><h2 id="感性认识"><a href="#感性认识" class="header-anchor">#</a> 感性认识</h2> <p>现阶段对于用户行为收集的方式，大抵分为三种：</p> <ul><li><strong>埋点上报</strong>：前端开发人员在代码中添加需要收集的数据信息，上报给服务。这种方式的优点是数据收集的很全，并且数据来源比较灵活，缺点是开发人员的工作量会比较大，并且对于一些历史项目不太友好。</li> <li><strong>全埋点</strong>：通过添加一段js脚本，给页面上几乎所有（实际上是大多数常用的事件，记录dom的所有事件是不现实的）的事件绑定监听，记录全量日志。这种方式的局限性比较大，数据收集的目的性不强，并且有可能收集不全。</li> <li><strong>可视化埋点</strong>：通过一种可视化的配置界面，提供给开发人员或者是业务工作人员自定义配置的能力，同时在用户使用的时候添加相应的事件监听。这种方式的好处是开发人员在代码方面的工作比较轻量，只需要引入一段js脚本，并且对配置人员的代码熟悉程度要求不高，缺点是数据收集完全依赖于配置，没有配置的用户行为完全监控不了，这对于产品的优化方面并不友好（可能由于界面设计或者交互体验的问题，用户在某个业务线上来回折腾，而迟迟不能完成功能，这种行为监控起来就比较麻烦了）。</li></ul> <p>上面的三种情况各有利弊，综合考虑，我们尝试采用 <strong>全埋点</strong> 加 <strong>可视化埋点</strong> 的组合方案，即在收集全量日志的同时，配合可视化埋点的配置整合起来，上报给服务。</p> <h2 id="两种模式"><a href="#两种模式" class="header-anchor">#</a> 两种模式</h2> <p>由于目标页面需要兼顾行为收集和配置添加，因此在JS-SDK内部存在两种模式：<strong>埋点模式</strong> 和 <strong>配置模式</strong>。</p> <h3 id="埋点模式"><a href="#埋点模式" class="header-anchor">#</a> 埋点模式</h3> <p>当JS-SDK初始化的时候，会首先去拿一次配置信息，再给整个document的submit、change、click等一系列事件设置监听器，同时比较配置信息和添加的默认埋点事件比较，将需要特殊记录的事件绑定单独的监听器。当document的监听器监听到绑定的事件时，会先根据event.target去拿到当前目标元素的id，与配置信息比较，区分普通事件和特殊事件上报给服务。</p> <h3 id="配置模式"><a href="#配置模式" class="header-anchor">#</a> 配置模式</h3> <p>可视化配置页开启配置的方式是用一个iframe去加载目标页，并且配置页和目标页的数据通信通过postmassage来完成（需指定origin）。<br>
开启配置模式需要在配置页的iframe添加对应的签名作为query，并且出于安全考虑，JS-SDK只负责在配置的时候高亮显示目标元素，而目标元素对应的事件信息的添加以及保存，全部交由配置页处理。</p> <p>这里附上GrowingIO的可视化配置截图：</p> <p><img src="/blog/img/ha-js-sdk/GrowingIO.png" alt="GrowingIO可视化配置"></p> <h2 id="元素定位策略"><a href="#元素定位策略" class="header-anchor">#</a> 元素定位策略</h2> <p>对于用户行为的触发单元，元素定位是必不可少的，我们需要确定到页面上的某个唯一的元素并拿到它的 ID（此处的id类似于元素的签名，并非css的id选择器），之前想要用 <code>XPath</code> 作为元素的签名，但是如果页面嵌套过深，XPath会很长，在服务记录的时候比较消耗资源，后来参考了 <a href="https://github.com/rowthan/whats-element" title="https://github.com/rowthan/whats-element" target="_blank" rel="noopener noreferrer">whats-element<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 的方式，并做了一些优化处理。</p> <p>通过对 <code>whats-element</code> 的源码分析，大致思路如下：</p> <ol><li>检查Ele是否是HTMLElement</li> <li>检查是否存在id</li> <li>若上一步未命中，检查是否存在name</li> <li>若上一步未命中，检查是否有className</li> <li>若上一步未命中，用混合查找的方式查找</li> <li>若上一步未命中，用querySelectorAll命中所有的元素，遍历过滤</li> <li>若上一步未命中，用递归的方式查找父级，再用querySelectorAll命中所有的元素，遍历过滤</li></ol> <p>可以看到任何一个步骤只要命中了目标元素，后面的就直接跳过，并且每一个步骤都是越来越深层次的匹配。其目的就是尽量收集到更少更简单的元素信息，并且又能拿到唯一代表一个元素的句柄。</p> <p>以下为源码部分：（为了方便阅读，只提取关键代码）</p> <div class="language-js extra-class"><pre class="language-js"><code>whatsElementPure<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">getUniqueId</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">element<span class="token punctuation">,</span> parent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 输入：event.target，作为 element</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>element <span class="token keyword">instanceof</span> <span class="token class-name">HTMLElement</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// 1. 检查Ele是否是HTMLElement</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 初始化配置</span>
    <span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token punctuation">{</span>
        wid<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
        type<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 2. 检查是否存在id</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">&amp;&amp;</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token operator">===</span> element<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 判断：getElementById(id) === Ele</span>
        result<span class="token punctuation">.</span>wid <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>tag<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">#</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
        result<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'document.getElementById()'</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 3. 检查是否存在name</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">.</span>wid <span class="token operator">&amp;&amp;</span> name <span class="token operator">&amp;&amp;</span> document<span class="token punctuation">.</span><span class="token function">getElementsByName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> element<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 判断：getElementsByName(name)[0] === Ele</span>
        result<span class="token punctuation">.</span>wid <span class="token operator">=</span> name
        result<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'document.getElementsByName()'</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 4. 检查是否有className</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">.</span>wid <span class="token operator">&amp;&amp;</span> className <span class="token operator">&amp;&amp;</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span>tag<span class="token operator">+</span>className<span class="token punctuation">)</span> <span class="token operator">===</span> element<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 判断：querySelector(tag+className) === Ele</span>
        result<span class="token punctuation">.</span>wid <span class="token operator">=</span> tag<span class="token operator">+</span>className
        result<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'document.querySelector()'</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 5. 用混合查找的方式</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">.</span>wid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 拼接tag+name+className</span>
        queryString <span class="token operator">=</span> tag<span class="token punctuation">;</span>
        queryString <span class="token operator">=</span> queryString <span class="token operator">+</span> className
        queryString <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>queryString<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">[name='</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">']</span><span class="token template-punctuation string">`</span></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>whatsElementPure<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">getTarget</span><span class="token punctuation">(</span>queryString<span class="token punctuation">)</span> <span class="token operator">===</span> element<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            result<span class="token punctuation">.</span>wid <span class="token operator">=</span> queryString
            result<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'document.querySelector()'</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 6. 用querySelectorAll命中所有的元素，遍历过滤</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">.</span>wid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 拼接tag+className</span>
        queryString <span class="token operator">=</span> tag
        queryString <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>queryString<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>className<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>

        <span class="token keyword">var</span> elements <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span>queryString<span class="token punctuation">)</span>
        <span class="token comment">// 遍历匹配querySelector(queryString+:nth-child(&quot;+index+&quot;)) === Ele</span>
        queryString <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>queryString<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:nth-child(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>index<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span>
        result<span class="token punctuation">.</span>wid <span class="token operator">=</span> queryString
        result<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'document.querySelector()'</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 7. 用递归的方式查找父级，再用querySelectorAll命中所有的元素，遍历过滤</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">.</span>wid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 递归拿到父级句柄</span>
        <span class="token keyword">var</span> parentQueryResult <span class="token operator">=</span> whatsElementPure<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">getUniqueId</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span>parentNode<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
        parentQueryString <span class="token operator">=</span> parentQueryResult<span class="token punctuation">.</span>wid

        <span class="token comment">// 拼接父子句柄</span>
        <span class="token keyword">var</span> queryString <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>parentQueryString<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>tag<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>

        <span class="token keyword">var</span> queryElements <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span>queryString<span class="token punctuation">)</span>
        <span class="token comment">// 遍历匹配querySelector(parentQueryString+&quot;&gt;&quot;+queryString+:nth-child(&quot;+index+&quot;)) === Ele</span>
        queryString <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>parentQueryString<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>tag<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:nth-child(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>index<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span>
        result<span class="token punctuation">.</span>wid <span class="token operator">=</span> queryString
        result<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'document.querySelector()'</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 输出结果</span>
    <span class="token keyword">return</span> result
<span class="token punctuation">}</span>

<span class="token comment">// 混合方式查找</span>
whatsElementPure<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">getTarget</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">queryString</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span>queryString<span class="token punctuation">)</span> <span class="token operator">||</span> document<span class="token punctuation">.</span><span class="token function">getElementsByName</span><span class="token punctuation">(</span>queryString<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">||</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span>queryString<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>可以看到想要定位一个元素，实际上不一定需要拿到元素完整的 <code>XPath</code> ，我们只要获取到某个签名串，能够通过浏览器的DOM操作API拿到唯一一个元素，这就是我们想要的元素 ID。</p> <h2 id="全埋点事件监听"><a href="#全埋点事件监听" class="header-anchor">#</a> 全埋点事件监听</h2> <p>想要记录全量日志，就需要对于各种dom事件添加监控，这些事件可以大致分为 <strong>瞬发事件</strong> 和 <strong>持续事件</strong> 。这里我们提供了一些基础事件的监控：</p> <h3 id="瞬发"><a href="#瞬发" class="header-anchor">#</a> 瞬发</h3> <ul><li>load：加载事件</li> <li>online / offline：连线、离线状态事件</li> <li>focus / blur：焦点聚集、焦点失去事件，（过滤出 <code>input</code> / <code>textarea</code> ）</li> <li>click / dblclick：单击、双击事件，（过滤出 <code>a</code> / <code>input</code> / <code>button</code> ）</li> <li>play / pause：播放、暂停事件，（过滤出 <code>video</code> / <code>audio</code> ）</li> <li>popstate / hashchange：路由变化事件</li></ul> <h3 id="持续"><a href="#持续" class="header-anchor">#</a> 持续</h3> <ul><li>change：输入事件，（过滤出 <code>input</code> / <code>textarea</code> ）</li> <li>touchmove：滑动事件</li></ul> <div class="custom-block warning"><p class="custom-block-title">注意：</p> <p>由于记录全量日志，对于服务的压力会比较大，因此持续事件的记录需要做限流处理（如滚动事件200ms记录一次，输入事件在停止输入之后的300ms后记录一次，具体情况具体分析）。</p></div> <h2 id="event事件模型"><a href="#event事件模型" class="header-anchor">#</a> Event事件模型</h2> <p>这里我们参考了神策的 <code>Event-User</code> 事件模型。
一个 <code>Event</code> 就是描述了：一个用户在某个时间点、某个地方，以某种方式完成了某个具体的事情。<br>
从这可以看出，一个完整的Event，包含如下的几个关键因素：</p> <h3 id="who"><a href="#who" class="header-anchor">#</a> who</h3> <p>即参与这个事件的用户是谁。根据我们的实际情况，我们使用 primary_id 来设置用户的唯一的cookie作为匿名 ID。同时我们也会去抓取 <code>location.query</code> 里面的 <code>openId</code> 字段（如果能正常获取到），上报nginx日志，作为在spark数据聚合处理阶段阶段，关联上用户五要素使用，形成完整的用户视图。</p> <h3 id="when"><a href="#when" class="header-anchor">#</a> when</h3> <p>即这个事件发生的实际时间。在我们的数据接口中，会同时记录服务端和客户端的时间，前者作为统一时间线，后者提供给某些记录时长的数据使用，二者都精确到毫秒。</p> <h3 id="where"><a href="#where" class="header-anchor">#</a> where</h3> <p>即事件发生的地点。nginx日志会记录用户访问时候的IP地址，根据IP我们可以获取到用户的具体地址、经纬度等信息。</p> <h3 id="how"><a href="#how" class="header-anchor">#</a> how</h3> <p>即用户从事这个事件的方式。这个概念就比较广了，包括用户使用的设备、使用的浏览器、操作系统版本、进入的渠道、跳转过来时的 referer 等。<br>
1. $browser： 浏览器信息，字符串类型，如&quot;Chrome&quot;。<br>
2. $model： 设备型号，字符串类型，如&quot;iphone6&quot;。<br>
3. $os： 操作系统，字符串类型，如&quot;iOS&quot;。<br>
4. $os_version： 操作系统版本，字符串类型，如&quot;8.1.1&quot;。<br>
5. $screen_height： 屏幕高度，数字类型，如1920。<br>
6. $screen_width： 屏幕宽度，数字类型，如1080。<br>
7. $wifi： 是否 WIFI，BOOL类型，如true。</p> <h3 id="what"><a href="#what" class="header-anchor">#</a> what</h3> <p>描述用户所做的这个事件的具体内容。在我们的数据接口中，首先是使用 <code>event</code> 记录当前触发的dom事件名称，来对用户所做的内容做初步的分类。后续在可视化配置阶段会提供给配置人员设置特殊事件（附带感情色彩的事件，可以是用户某个具体行为的目的，也可以是各种业务相关的功能事件）的入口。下面给出一些典型的例子:<br>
1. 对于一个“购买”类型的事件，则可能需要记录的字段有：商品名称、商品类型、购买数量、购买金额、付款方式等。<br>
2. 对于一个“搜索”类型的事件，则可能需要记录的字段有：搜索关键词、搜索类型等。<br>
3. 对于一个“填写表格”类型的事件，则可能需要记录的字段有：表格类型、表格关键信息等。<br>
4. 对于一个“用户注册”类型的事件，则可能需要记录的字段有：注册渠道、用户基本信息等。</p> <h2 id="整体流程"><a href="#整体流程" class="header-anchor">#</a> 整体流程</h2> <p>根据以上各技术细节的描述，可将整体流程概括为两方面：</p> <ul><li><p>行为记录：</p> <ol><li>JS-SDK被添加进目标页面，初始化。</li> <li>读取配置信息json，配合全埋点的默认事件，给目标页面元素绑定上对应的监听。</li> <li>用户触发某个功能埋点，JS-SDK请求一张1*1大小的gif，并附带相应的数据，在nginx保存一条日志。</li></ol></li> <li><p>配置：</p> <ol><li>配置人员打开目标界面。</li> <li>输入URL，打开目标页面。</li> <li>开启配置功能，选择目标元素。</li> <li>添加相应事件信息。</li> <li>点击保存配置，将配置信息json保存在服务某处。</li></ol></li></ul> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>无埋点用户行为收集实际上并非无埋点，而是通过可视化配置埋点的方式将需要记录的具体用户行为做抽象，达到收集的数据更具有目的性，并且最大限度的减轻人力成本的目的。数据收集的准确度直接影响后续数据分析的结果，我们需要在后续的开发和维护中根据具体细节作出相应调整。</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">12/2/2019, 9:23:57 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/blog/whatever/RxJS的响应式原理.html" class="prev">
          RxJS的响应式原理
        </a></span> <span class="next"><a href="/blog/FE-Foundation/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6%E5%9F%BA%E7%A1%80/">
          目录
        </a>
        →
      </span></p></div> </main> <!----> <div class="comments-wrapper" data-v-ad130a7c><!----></div></div></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-a81d141e data-v-a81d141e><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-a81d141e><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-a81d141e></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-a81d141e></path></svg></div></div></div>
    <script src="/blog/assets/js/app.49d49959.js" defer></script><script src="/blog/assets/js/3.66f9ff46.js" defer></script><script src="/blog/assets/js/1.0064e023.js" defer></script><script src="/blog/assets/js/55.b18fd02a.js" defer></script>
  </body>
</html>
